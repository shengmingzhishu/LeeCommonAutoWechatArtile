<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾®ä¿¡å…¬ä¼—å·æ–‡ç« æ’ç‰ˆå·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            height: 100vh;
            display: flex;
            overflow: hidden;
            background-color: #f5f5f5;
        }
        
        /* å·¦ä¾§ç»„ä»¶é¢æ¿ */
        .sidebar {
            width: 280px;
            background-color: #fff;
            border-right: 1px solid #ddd;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        .sidebar h3 {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            color: #333;
        }
        
        .components, .templates, .saved-templates {
            margin-bottom: 20px;
        }
        
        .section-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .section-title h4 {
            margin: 0;
            color: #555;
        }
        
        .section-title button {
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 2px 8px;
            font-size: 12px;
            cursor: pointer;
        }
        
        .component-item, .template-item, .saved-template-item {
            padding: 10px;
            margin: 5px 0;
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .component-item:hover, .template-item:hover, .saved-template-item:hover {
            background-color: #e9ecef;
            border-color: #adb5bd;
        }
        
        .component-item .desc, .template-item .desc {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }
        
        .saved-template-item {
            padding: 12px;
        }
        
        .saved-template-item h5 {
            margin: 0 0 5px 0;
            color: #333;
        }
        
        .saved-template-item p {
            margin: 5px 0;
            font-size: 13px;
            color: #666;
        }
        
        .saved-template-item .actions {
            margin-top: 8px;
            display: flex;
            gap: 5px;
        }
        
        .saved-template-item button {
            padding: 4px 8px;
            font-size: 12px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        
        .btn-load {
            background-color: #28a745;
            color: white;
        }
        
        .btn-delete {
            background-color: #dc3545;
            color: white;
        }
        
        .btn-edit {
            background-color: #ffc107;
            color: black;
        }
        
        /* ä¸»ç¼–è¾‘åŒºåŸŸ */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 15px;
            overflow: hidden;
        }
        
        .toolbar {
            padding: 10px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .toolbar-group {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 0 10px;
            border-right: 1px solid #eee;
        }
        
        .toolbar-group:last-child {
            border-right: none;
        }
        
        .toolbar button {
            padding: 6px 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: background-color 0.3s;
        }
        
        .toolbar button:hover {
            background-color: #0056b3;
        }
        
        .toolbar select, .toolbar input[type="color"] {
            padding: 4px 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }
        
        .toolbar .format-btn {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .editor-container {
            flex: 1;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: auto;
            padding: 20px;
            position: relative;
        }
        
        #editor-svg {
            width: 100%;
            height: 100%;
        }
        
        .element {
            cursor: move;
        }
        
        .selected {
            stroke: #007bff;
            stroke-width: 2px;
        }
        
        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 70%;
            border-radius: 8px;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal h3 {
            margin-top: 0;
        }
        
        .modal input, .modal select, .modal textarea {
            width: 100%;
            padding: 8px;
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        .modal-buttons {
            margin-top: 15px;
            text-align: right;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        .modal-buttons button {
            padding: 8px 15px;
            margin-left: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .modal-buttons .confirm-btn {
            background-color: #28a745;
            color: white;
        }
        
        .modal-buttons .cancel-btn {
            background-color: #6c757d;
            color: white;
        }
        
        .modal-buttons .action-btn {
            background-color: #17a2b8;
            color: white;
        }
        
        /* ç»„ä»¶é¢„è§ˆ */
        .component-preview {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .preview-icon {
            width: 24px;
            height: 24px;
            background-color: #007bff;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
        }
        
        /* æœç´¢æ¡† */
        .search-box {
            margin-bottom: 10px;
        }
        
        .search-box input {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }
        
        /* æ ¼å¼åŒ–å·¥å…·æ å¢å¼º */
        .format-panel {
            display: none;
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 100;
        }
        
        .format-panel button {
            width: 28px;
            height: 28px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            margin: 2px;
        }
        
        .format-panel select {
            padding: 4px;
            margin: 2px;
        }
        
        .format-panel input[type="color"] {
            width: 28px;
            height: 28px;
            padding: 0;
            margin: 2px;
        }
        
        /* å›¾ç‰‡ä¸Šä¼ æ ·å¼ */
        .image-upload-panel {
            display: none;
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 100;
            width: 300px;
        }
        
        .image-upload-panel input {
            width: 100%;
            margin: 5px 0;
        }
        
        .image-preview {
            width: 100%;
            height: 150px;
            border: 1px solid #eee;
            border-radius: 4px;
            margin: 10px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        .image-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        /* å›¾ä¹¦å±•ç¤ºæ ·å¼ */
        .book-item {
            display: flex;
            margin: 15px 0;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 6px;
            background-color: #fafafa;
        }
        
        .book-cover {
            width: 80px;
            height: 100px;
            background-color: #e9ecef;
            border-radius: 4px;
            margin-right: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: 12px;
            text-align: center;
        }
        
        .book-info {
            flex: 1;
        }
        
        .book-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .book-author {
            color: #6c757d;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .book-desc {
            font-size: 13px;
            color: #495057;
        }
        
        /* MDä¼˜åŒ–é¢„è§ˆæ ·å¼ */
        .md-preview {
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 4px;
            margin: 10px 0;
            background-color: #f8f9fa;
        }
        
        .md-preview h1, .md-preview h2, .md-preview h3 {
            margin: 10px 0;
            color: #333;
        }
        
        .md-preview p {
            margin: 8px 0;
            line-height: 1.6;
        }
        
        .md-preview strong {
            font-weight: bold;
            color: #d32f2f;
        }
        
        .md-preview em {
            font-style: italic;
            color: #1976d2;
        }
        
        .md-preview code {
            background-color: #f1f1f1;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: monospace;
        }
        
        .md-preview blockquote {
            margin: 10px 0;
            padding: 10px 15px;
            border-left: 4px solid #007bff;
            background-color: #f8f9fa;
            color: #6c757d;
        }
        
        .md-preview ul, .md-preview ol {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .md-preview li {
            margin: 5px 0;
        }
        
        /* å‘å¸ƒé¢æ¿ */
        .publish-panel {
            display: none;
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 100;
            width: 400px;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }
        
        .publish-panel h3 {
            margin-top: 0;
            margin-bottom: 15px;
        }
        
        .publish-panel .form-group {
            margin-bottom: 15px;
        }
        
        .publish-panel label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .publish-panel input, .publish-panel textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        .publish-panel .actions {
            text-align: right;
            margin-top: 20px;
        }
        
        .publish-panel .actions button {
            margin-left: 10px;
            padding: 8px 15px;
        }
    </style>
</head>
<body>
    <!-- å·¦ä¾§ç»„ä»¶é¢æ¿ -->
    <div class="sidebar">
        <div class="search-box">
            <input type="text" id="component-search" placeholder="æœç´¢ç»„ä»¶æˆ–æ¨¡æ¿...">
        </div>
        
        <div class="components">
            <div class="section-title">
                <h4>ç»„ä»¶åº“</h4>
            </div>
            <div class="component-item" data-type="title">
                <div class="component-preview">
                    <div class="preview-icon">T</div>
                    <div>
                        <strong>æ ‡é¢˜ç»„ä»¶</strong>
                        <div class="desc">ç”¨äºæ–‡ç« æ ‡é¢˜</div>
                    </div>
                </div>
            </div>
            <div class="component-item" data-type="text">
                <div class="component-preview">
                    <div class="preview-icon">æ–‡</div>
                    <div>
                        <strong>æ–‡å­—ç»„ä»¶</strong>
                        <div class="desc">ç”¨äºæ­£æ–‡å†…å®¹</div>
                    </div>
                </div>
            </div>
            <div class="component-item" data-type="image">
                <div class="component-preview">
                    <div class="preview-icon">å›¾</div>
                    <div>
                        <strong>å›¾ç‰‡ç»„ä»¶</strong>
                        <div class="desc">ç”¨äºæ’å…¥å›¾ç‰‡</div>
                    </div>
                </div>
            </div>
            <div class="component-item" data-type="divider">
                <div class="component-preview">
                    <div class="preview-icon">â”€</div>
                    <div>
                        <strong>åˆ†å‰²çº¿</strong>
                        <div class="desc">ç”¨äºåˆ†éš”å†…å®¹</div>
                    </div>
                </div>
            </div>
            <div class="component-item" data-type="blockquote">
                <div class="component-preview">
                    <div class="preview-icon">â€</div>
                    <div>
                        <strong>å¼•ç”¨å—</strong>
                        <div class="desc">ç”¨äºå¼•ç”¨å†…å®¹</div>
                    </div>
                </div>
            </div>
            <div class="component-item" data-type="list">
                <div class="component-preview">
                    <div class="preview-icon">â€¢</div>
                    <div>
                        <strong>åˆ—è¡¨ç»„ä»¶</strong>
                        <div class="desc">ç”¨äºé¡¹ç›®åˆ—è¡¨</div>
                    </div>
                </div>
            </div>
            <div class="component-item" data-type="highlight">
                <div class="component-preview">
                    <div class="preview-icon">H</div>
                    <div>
                        <strong>é«˜äº®æ–‡æœ¬</strong>
                        <div class="desc">ç”¨äºå…³é”®è¯çªå‡º</div>
                    </div>
                </div>
            </div>
            <div class="component-item" data-type="book">
                <div class="component-preview">
                    <div class="preview-icon">B</div>
                    <div>
                        <strong>å›¾ä¹¦ç»„ä»¶</strong>
                        <div class="desc">ç”¨äºå›¾ä¹¦ä»‹ç»</div>
                    </div>
                </div>
            </div>
            <div class="component-item" data-type="markdown">
                <div class="component-preview">
                    <div class="preview-icon">M</div>
                    <div>
                        <strong>MDä¼˜åŒ–ç»„ä»¶</strong>
                        <div class="desc">ç”¨äºMDæ ¼å¼ä¼˜åŒ–</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="templates">
            <div class="section-title">
                <h4>é»˜è®¤æ¨¡æ¿</h4>
            </div>
            <div class="template-item" data-template="default">
                <strong>åŸºç¡€æ’ç‰ˆ</strong>
                <div class="desc">ç®€å•çš„æ ‡é¢˜+æ­£æ–‡å¸ƒå±€</div>
            </div>
            <div class="template-item" data-template="image">
                <strong>å›¾ç‰‡æ’ç‰ˆ</strong>
                <div class="desc">å›¾ç‰‡+æ–‡å­—æè¿°å¸ƒå±€</div>
            </div>
            <div class="template-item" data-template="book">
                <strong>å›¾ä¹¦ä»‹ç»</strong>
                <div class="desc">å¤šæœ¬ä¹¦ç±ä»‹ç»å¸ƒå±€</div>
            </div>
            <div class="template-item" data-template="md">
                <strong>MDä¼˜åŒ–</strong>
                <div class="desc">Markdownæ ¼å¼ä¼˜åŒ–</div>
            </div>
        </div>
        
        <div class="saved-templates">
            <div class="section-title">
                <h4>æˆ‘çš„æ¨¡æ¿</h4>
                <button id="refresh-templates-btn">åˆ·æ–°</button>
            </div>
            <div id="saved-templates-container">
                <!-- åŠ¨æ€åŠ è½½ä¿å­˜çš„æ¨¡æ¿ -->
            </div>
        </div>
        
        <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee;">
            <button id="save-template-btn" style="width: 100%; padding: 10px; margin-bottom: 8px;">ğŸ’¾ ä¿å­˜ä¸ºæ¨¡æ¿</button>
            <button id="import-template-btn" style="width: 100%; padding: 10px; margin-bottom: 8px;">ğŸ“¥ å¯¼å…¥æ¨¡æ¿</button>
            <button id="export-template-btn" style="width: 100%; padding: 10px; margin-bottom: 8px;">ğŸ“¤ å¯¼å‡ºæ¨¡æ¿</button>
            <input type="file" id="template-file" accept=".json" style="display: none;">
        </div>
    </div>
    
    <!-- ä¸»ç¼–è¾‘åŒºåŸŸ -->
    <div class="main-content">
        <div class="toolbar">
            <div class="toolbar-group">
                <button id="undo-btn">æ’¤é”€</button>
                <button id="redo-btn">é‡åš</button>
                <button id="clear-btn">æ¸…ç©º</button>
                <button id="publish-btn">å‘å¸ƒ</button>
            </div>
            
            <div class="toolbar-group">
                <select id="font-family">
                    <option value="Microsoft YaHei">å¾®è½¯é›…é»‘</option>
                    <option value="SimSun">å®‹ä½“</option>
                    <option value="SimHei">é»‘ä½“</option>
                    <option value="KaiTi">æ¥·ä½“</option>
                    <option value="Arial">Arial</option>
                    <option value="Georgia">Georgia</option>
                </select>
                <select id="font-size">
                    <option value="12">12px</option>
                    <option value="14">14px</option>
                    <option value="16" selected>16px</option>
                    <option value="18">18px</option>
                    <option value="20">20px</option>
                    <option value="24">24px</option>
                    <option value="28">28px</option>
                    <option value="32">32px</option>
                </select>
            </div>
            
            <div class="toolbar-group">
                <button id="bold-btn" class="format-btn">B</button>
                <button id="italic-btn" class="format-btn">I</button>
                <button id="underline-btn" class="format-btn">U</button>
                <button id="strikethrough-btn" class="format-btn">S</button>
            </div>
            
            <div class="toolbar-group">
                <input type="color" id="text-color" value="#000000" title="æ–‡å­—é¢œè‰²">
                <input type="color" id="bg-color" value="#ffffff" title="èƒŒæ™¯é¢œè‰²">
            </div>
            
            <div class="toolbar-group">
                <button id="align-left">å·¦å¯¹é½</button>
                <button id="align-center">å±…ä¸­</button>
                <button id="align-right">å³å¯¹é½</button>
                <button id="align-justify">ä¸¤ç«¯å¯¹é½</button>
            </div>
            
            <div class="toolbar-group">
                <button id="copy-btn">å¤åˆ¶</button>
                <button id="paste-btn">ç²˜è´´</button>
                <button id="delete-btn">åˆ é™¤</button>
            </div>
            
            <div class="toolbar-group">
                <button id="insert-link">æ’å…¥é“¾æ¥</button>
                <button id="insert-emoji">æ’å…¥è¡¨æƒ…</button>
                <button id="convert-md">è½¬æ¢MD</button>
            </div>
            
            <div class="toolbar-group">
                <button id="upload-image">ä¸Šä¼ å›¾ç‰‡</button>
                <button id="add-book">æ·»åŠ å›¾ä¹¦</button>
            </div>
        </div>
        
        <div class="editor-container">
            <svg id="editor-svg" xmlns="http://www.w3.org/2000/svg"></svg>
            <!-- æ ¼å¼åŒ–é¢æ¿ -->
            <div id="format-panel" class="format-panel">
                <select id="format-font-family">
                    <option value="Microsoft YaHei">å¾®è½¯é›…é»‘</option>
                    <option value="SimSun">å®‹ä½“</option>
                    <option value="SimHei">é»‘ä½“</option>
                    <option value="KaiTi">æ¥·ä½“</option>
                    <option value="Arial">Arial</option>
                    <option value="Georgia">Georgia</option>
                </select>
                <select id="format-font-size">
                    <option value="12">12px</option>
                    <option value="14">14px</option>
                    <option value="16" selected>16px</option>
                    <option value="18">18px</option>
                    <option value="20">20px</option>
                    <option value="24">24px</option>
                    <option value="28">28px</option>
                    <option value="32">32px</option>
                </select>
                <button id="format-bold" class="format-btn">B</button>
                <button id="format-italic" class="format-btn">I</button>
                <button id="format-underline" class="format-btn">U</button>
                <input type="color" id="format-text-color" value="#000000" title="æ–‡å­—é¢œè‰²">
                <button id="format-align-left" class="format-btn">L</button>
                <button id="format-align-center" class="format-btn">C</button>
                <button id="format-align-right" class="format-btn">R</button>
            </div>
            
            <!-- å›¾ç‰‡ä¸Šä¼ é¢æ¿ -->
            <div id="image-upload-panel" class="image-upload-panel">
                <h4>ä¸Šä¼ å›¾ç‰‡</h4>
                <input type="file" id="image-upload-input" accept="image/*">
                <button id="upload-btn">ä¸Šä¼ </button>
                <button id="url-btn">ä½¿ç”¨URL</button>
                <div class="image-preview">
                    <div id="image-preview-container">è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶</div>
                </div>
                <input type="text" id="image-url-input" placeholder="æˆ–è¾“å…¥å›¾ç‰‡URL" style="display: none;">
                <div style="margin-top: 10px;">
                    <label>å®½åº¦: <input type="number" id="image-width" value="300" min="50" max="1000"></label>
                    <label>é«˜åº¦: <input type="number" id="image-height" value="200" min="50" max="1000"></label>
                </div>
            </div>
            
            <!-- å›¾ä¹¦æ·»åŠ é¢æ¿ -->
            <div id="book-add-panel" class="image-upload-panel">
                <h4>æ·»åŠ å›¾ä¹¦</h4>
                <div>
                    <label>å›¾ä¹¦å°é¢URL:</label>
                    <input type="text" id="book-cover-url" placeholder="è¾“å…¥å›¾ä¹¦å°é¢å›¾ç‰‡URL">
                </div>
                <div>
                    <label>å›¾ä¹¦åç§°:</label>
                    <input type="text" id="book-title" placeholder="è¾“å…¥å›¾ä¹¦åç§°">
                </div>
                <div>
                    <label>ä½œè€…:</label>
                    <input type="text" id="book-author" placeholder="è¾“å…¥ä½œè€…å">
                </div>
                <div>
                    <label>ç®€ä»‹:</label>
                    <textarea id="book-desc" placeholder="è¾“å…¥å›¾ä¹¦ç®€ä»‹" rows="3"></textarea>
                </div>
                <div style="margin-top: 10px; text-align: right;">
                    <button id="add-book-confirm">æ·»åŠ </button>
                    <button id="add-book-cancel">å–æ¶ˆ</button>
                </div>
            </div>
            
            <!-- MDè½¬æ¢é¢æ¿ -->
            <div id="md-convert-panel" class="image-upload-panel">
                <h4>Markdownè½¬æ¢</h4>
                <textarea id="md-input" placeholder="è¯·è¾“å…¥Markdownæ ¼å¼æ–‡æœ¬" rows="6"></textarea>
                <div style="margin: 10px 0;">
                    <label>è½¬æ¢é€‰é¡¹:</label>
                    <div>
                        <input type="checkbox" id="md-bold" checked> <label for="md-bold">ç²—ä½“ä¼˜åŒ–</label>
                        <input type="checkbox" id="md-italic" checked style="margin-left: 10px;"> <label for="md-italic">æ–œä½“ä¼˜åŒ–</label>
                    </div>
                    <div>
                        <input type="checkbox" id="md-headers" checked> <label for="md-headers">æ ‡é¢˜ä¼˜åŒ–</label>
                        <input type="checkbox" id="md-blockquotes" checked style="margin-left: 10px;"> <label for="md-blockquotes">å¼•ç”¨å—ä¼˜åŒ–</label>
                    </div>
                </div>
                <div style="text-align: right; margin-top: 10px;">
                    <button id="convert-md-confirm">è½¬æ¢</button>
                    <button id="convert-md-cancel">å–æ¶ˆ</button>
                </div>
                <div id="md-preview" class="md-preview" style="display: none; margin-top: 10px;"></div>
            </div>
            
            <!-- å‘å¸ƒé¢æ¿ -->
            <div id="publish-panel" class="publish-panel">
                <h3>å‘å¸ƒæ–‡ç« </h3>
                <div class="form-group">
                    <label for="article-title">æ–‡ç« æ ‡é¢˜:</label>
                    <input type="text" id="article-title" placeholder="è¯·è¾“å…¥æ–‡ç« æ ‡é¢˜">
                </div>
                <div class="form-group">
                    <label for="article-author">ä½œè€…:</label>
                    <input type="text" id="article-author" placeholder="è¯·è¾“å…¥ä½œè€…å">
                </div>
                <div class="form-group">
                    <label for="article-summary">æ‘˜è¦:</label>
                    <textarea id="article-summary" placeholder="è¯·è¾“å…¥æ–‡ç« æ‘˜è¦" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="article-cover">å°é¢å›¾URL:</label>
                    <input type="text" id="article-cover" placeholder="è¯·è¾“å…¥å°é¢å›¾URL">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="is-original"> æ ‡è®°ä¸ºåŸåˆ›
                    </label>
                </div>
                <div class="actions">
                    <button class="cancel-btn" id="cancel-publish">å–æ¶ˆ</button>
                    <button class="action-btn" id="confirm-publish">ç¡®è®¤å‘å¸ƒ</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- æ¨¡æ¿ä¿å­˜æ¨¡æ€æ¡† -->
    <div id="save-template-modal" class="modal">
        <div class="modal-content">
            <h3>ä¿å­˜æ¨¡æ¿</h3>
            <label>æ¨¡æ¿åç§°:</label>
            <input type="text" id="template-name" placeholder="è¯·è¾“å…¥æ¨¡æ¿åç§°">
            <label>æ¨¡æ¿æè¿°:</label>
            <textarea id="template-desc" rows="3" placeholder="è¯·è¾“å…¥æ¨¡æ¿æè¿°"></textarea>
            <label>æ¨¡æ¿æ ‡ç­¾ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰:</label>
            <input type="text" id="template-tags" placeholder="å¦‚: å›¾ç‰‡,æ ‡é¢˜,æ­£æ–‡">
            <div class="modal-buttons">
                <button class="cancel-btn" id="cancel-save">å–æ¶ˆ</button>
                <button class="confirm-btn" id="confirm-save">ä¿å­˜æ¨¡æ¿</button>
            </div>
        </div>
    </div>
    
    <!-- æ¨¡æ¿ç®¡ç†æ¨¡æ€æ¡† -->
    <div id="template-manager-modal" class="modal">
        <div class="modal-content">
            <h3>æ¨¡æ¿ç®¡ç†</h3>
            <div id="all-templates-list">
                <!-- æ‰€æœ‰æ¨¡æ¿å°†åŠ¨æ€åŠ è½½åˆ°è¿™é‡Œ -->
            </div>
            <div class="modal-buttons">
                <button class="cancel-btn" id="close-template-manager">å…³é—­</button>
            </div>
        </div>
    </div>
    
    <script>
        // å…¨å±€çŠ¶æ€
        let editorState = {
            elements: [],
            selectedElement: null,
            history: [],
            historyIndex: -1,
            currentTemplate: null,
            clipboard: null  // ç”¨äºå¤åˆ¶ç²˜è´´åŠŸèƒ½
        };
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initEditor();
            bindEvents();
            loadSavedTemplatesToSidebar();
        });
        
        // åˆå§‹åŒ–ç¼–è¾‘å™¨
        function initEditor() {
            // åˆ›å»ºé»˜è®¤èƒŒæ™¯
            createDefaultBackground();
        }
        
        // åˆ›å»ºé»˜è®¤èƒŒæ™¯
        function createDefaultBackground() {
            const svg = document.getElementById('editor-svg');
            const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            rect.setAttribute('x', '0');
            rect.setAttribute('y', '0');
            rect.setAttribute('width', '100%');
            rect.setAttribute('height', '100%');
            rect.setAttribute('fill', '#ffffff');
            svg.appendChild(rect);
        }
        
        // ç»‘å®šäº‹ä»¶
        function bindEvents() {
            // ç»„ä»¶æ‹–æ‹½äº‹ä»¶
            document.querySelectorAll('.component-item').forEach(item => {
                item.addEventListener('click', function() {
                    const type = this.getAttribute('data-type');
                    if (type === 'book') {
                        showBookAddPanel();
                    } else if (type === 'markdown') {
                        showMdConvertPanel();
                    } else {
                        createElement(type);
                    }
                });
            });
            
            // æ¨¡æ¿é€‰æ‹©äº‹ä»¶
            document.querySelectorAll('.template-item').forEach(item => {
                item.addEventListener('click', function() {
                    const templateType = this.getAttribute('data-template');
                    loadTemplate(templateType);
                });
            });
            
            // å·¥å…·æ äº‹ä»¶
            document.getElementById('save-template-btn').addEventListener('click', showSaveTemplateModal);
            document.getElementById('import-template-btn').addEventListener('click', importTemplate);
            document.getElementById('export-template-btn').addEventListener('click', exportTemplate);
            document.getElementById('clear-btn').addEventListener('click', clearCanvas);
            document.getElementById('publish-btn').addEventListener('click', showPublishPanel);
            
            // æ¨¡æ€æ¡†äº‹ä»¶
            document.getElementById('cancel-save').addEventListener('click', hideSaveTemplateModal);
            document.getElementById('confirm-save').addEventListener('click', saveTemplate);
            
            // æ¨¡æ¿æ–‡ä»¶ä¸Šä¼ 
            document.getElementById('template-file').addEventListener('change', handleTemplateFile);
            
            // æ ¼å¼åŒ–äº‹ä»¶
            document.getElementById('bold-btn').addEventListener('click', toggleBold);
            document.getElementById('italic-btn').addEventListener('click', toggleItalic);
            document.getElementById('underline-btn').addEventListener('click', toggleUnderline);
            document.getElementById('strikethrough-btn').addEventListener('click', toggleStrikethrough);
            document.getElementById('text-color').addEventListener('change', changeTextColor);
            document.getElementById('bg-color').addEventListener('change', changeBgColor);
            document.getElementById('font-family').addEventListener('change', changeFontFamily);
            document.getElementById('font-size').addEventListener('change', changeFontSize);
            
            // å¯¹é½äº‹ä»¶
            document.getElementById('align-left').addEventListener('click', () => alignText('start'));
            document.getElementById('align-center').addEventListener('click', () => alignText('middle'));
            document.getElementById('align-right').addEventListener('click', () => alignText('end'));
            document.getElementById('align-justify').addEventListener('click', () => alignText('justify'));
            
            // ç¼–è¾‘æ“ä½œ
            document.getElementById('copy-btn').addEventListener('click', copyElement);
            document.getElementById('paste-btn').addEventListener('click', pasteElement);
            document.getElementById('delete-btn').addEventListener('click', deleteSelectedElement);
            
            // å†å²è®°å½•
            document.getElementById('undo-btn').addEventListener('click', undo);
            document.getElementById('redo-btn').addEventListener('click', redo);
            
            // æ’å…¥åŠŸèƒ½
            document.getElementById('insert-link').addEventListener('click', insertLink);
            document.getElementById('insert-emoji').addEventListener('click', insertEmoji);
            document.getElementById('convert-md').addEventListener('click', showMdConvertPanel);
            
            // å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½
            document.getElementById('upload-image').addEventListener('click', showImageUploadPanel);
            document.getElementById('upload-btn').addEventListener('click', uploadImage);
            document.getElementById('url-btn').addEventListener('click', useImageUrl);
            document.getElementById('image-upload-input').addEventListener('change', previewImage);
            
            // å›¾ä¹¦æ·»åŠ åŠŸèƒ½
            document.getElementById('add-book').addEventListener('click', showBookAddPanel);
            document.getElementById('add-book-confirm').addEventListener('click', addBook);
            document.getElementById('add-book-cancel').addEventListener('click', hideBookAddPanel);
            
            // MDè½¬æ¢åŠŸèƒ½
            document.getElementById('convert-md-confirm').addEventListener('click', convertMarkdown);
            document.getElementById('convert-md-cancel').addEventListener('click', hideMdConvertPanel);
            document.getElementById('md-input').addEventListener('input', previewMarkdown);
            
            // å‘å¸ƒåŠŸèƒ½
            document.getElementById('confirm-publish').addEventListener('click', publishToWeChat);
            document.getElementById('cancel-publish').addEventListener('click', hidePublishPanel);
            
            // åˆ·æ–°æ¨¡æ¿åˆ—è¡¨
            document.getElementById('refresh-templates-btn').addEventListener('click', loadSavedTemplatesToSidebar);
            
            // æ¨¡æ¿ç®¡ç†æ¨¡æ€æ¡†
            document.getElementById('close-template-manager').addEventListener('click', () => {
                document.getElementById('template-manager-modal').style.display = 'none';
            });
            
            // ç‚¹å‡»ç”»å¸ƒå–æ¶ˆé€‰æ‹©
            document.getElementById('editor-svg').addEventListener('click', function(e) {
                if (e.target === this) {
                    document.querySelectorAll('.element').forEach(el => {
                        el.classList.remove('selected');
                    });
                    document.getElementById('format-panel').style.display = 'none';
                    document.getElementById('image-upload-panel').style.display = 'none';
                    document.getElementById('book-add-panel').style.display = 'none';
                    document.getElementById('md-convert-panel').style.display = 'none';
                    editorState.selectedElement = null;
                }
            });
            
            // æœç´¢åŠŸèƒ½
            document.getElementById('component-search').addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                filterComponentsAndTemplates(searchTerm);
            });
            
            // é”®ç›˜å¿«æ·é”®
            document.addEventListener('keydown', function(e) {
                // Ctrl+S ä¿å­˜æ¨¡æ¿
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    showSaveTemplateModal();
                }
                
                // Ctrl+O æ‰“å¼€æ¨¡æ¿ç®¡ç†
                if (e.ctrlKey && e.key === 'o') {
                    e.preventDefault();
                    document.getElementById('template-manager-modal').style.display = 'block';
                    loadAllTemplatesToManager();
                }
                
                // Delete åˆ é™¤é€‰ä¸­å…ƒç´ 
                if (e.key === 'Delete' && editorState.selectedElement) {
                    deleteSelectedElement();
                }
                
                // Ctrl+C å¤åˆ¶
                if (e.ctrlKey && e.key === 'c' && editorState.selectedElement) {
                    e.preventDefault();
                    copyElement();
                }
                
                // Ctrl+V ç²˜è´´
                if (e.ctrlKey && e.key === 'v' && editorState.clipboard) {
                    e.preventDefault();
                    pasteElement();
                }
                
                // Ctrl+Z æ’¤é”€
                if (e.ctrlKey && e.key === 'z') {
                    e.preventDefault();
                    undo();
                }
                
                // Ctrl+Y é‡åš
                if ((e.ctrlKey && e.key === 'y') || (e.ctrlKey && e.shiftKey && e.key === 'Z')) {
                    e.preventDefault();
                    redo();
                }
            });
            
            // ä¸ºé€‰ä¸­çš„å…ƒç´ æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('element')) {
                    // éšè—å…¶ä»–é¢æ¿
                    document.getElementById('image-upload-panel').style.display = 'none';
                    document.getElementById('book-add-panel').style.display = 'none';
                    document.getElementById('md-convert-panel').style.display = 'none';
                    document.getElementById('publish-panel').style.display = 'none';
                    
                    if (e.target.tagName === 'text' || e.target.tagName === 'title') {
                        // æ˜¾ç¤ºæ ¼å¼åŒ–é¢æ¿
                        showFormatPanel(e.target);
                    }
                } else if (!e.target.closest('#format-panel') && 
                           !e.target.closest('#image-upload-panel') && 
                           !e.target.closest('#book-add-panel') && 
                           !e.target.closest('#md-convert-panel') && 
                           !e.target.closest('#publish-panel')) {
                    // ç‚¹å‡»å…¶ä»–åœ°æ–¹éšè—æ‰€æœ‰é¢æ¿
                    document.getElementById('format-panel').style.display = 'none';
                    document.getElementById('image-upload-panel').style.display = 'none';
                    document.getElementById('book-add-panel').style.display = 'none';
                    document.getElementById('md-convert-panel').style.display = 'none';
                    document.getElementById('publish-panel').style.display = 'none';
                }
            });
        }
        
        // æ˜¾ç¤ºæ ¼å¼åŒ–é¢æ¿
        function showFormatPanel(element) {
            if (element.tagName === 'text' || element.tagName === 'title') {
                const panel = document.getElementById('format-panel');
                const rect = element.getBoundingClientRect();
                const editorRect = document.querySelector('.editor-container').getBoundingClientRect();
                
                panel.style.display = 'block';
                panel.style.left = (rect.left - editorRect.left + rect.width / 2 - panel.offsetWidth / 2) + 'px';
                panel.style.top = (rect.top - editorRect.top - panel.offsetHeight - 5) + 'px';
                
                // ç»‘å®šæ ¼å¼åŒ–é¢æ¿äº‹ä»¶
                bindFormatPanelEvents(element);
            }
        }
        
        // ç»‘å®šæ ¼å¼åŒ–é¢æ¿äº‹ä»¶
        function bindFormatPanelEvents(element) {
            const panel = document.getElementById('format-panel');
            
            // å­—ä½“
            document.getElementById('format-font-family').onchange = function() {
                element.setAttribute('font-family', this.value);
                updateElementData(element);
                saveStateToHistory();
            };
            
            // å­—å·
            document.getElementById('format-font-size').onchange = function() {
                element.setAttribute('font-size', this.value);
                updateElementData(element);
                saveStateToHistory();
            };
            
            // ç²—ä½“
            document.getElementById('format-bold').onclick = function() {
                const currentWeight = element.getAttribute('font-weight') || 'normal';
                const newWeight = currentWeight === 'bold' ? 'normal' : 'bold';
                element.setAttribute('font-weight', newWeight);
                updateElementData(element);
                saveStateToHistory();
            };
            
            // æ–œä½“
            document.getElementById('format-italic').onclick = function() {
                const currentStyle = element.getAttribute('font-style') || 'normal';
                const newStyle = currentStyle === 'italic' ? 'normal' : 'italic';
                element.setAttribute('font-style', newStyle);
                updateElementData(element);
                saveStateToHistory();
            };
            
            // ä¸‹åˆ’çº¿
            document.getElementById('format-underline').onclick = function() {
                const currentTextDecoration = element.getAttribute('text-decoration') || 'none';
                const newDecoration = currentTextDecoration === 'underline' ? 'none' : 'underline';
                element.setAttribute('text-decoration', newDecoration);
                updateElementData(element);
                saveStateToHistory();
            };
            
            // é¢œè‰²
            document.getElementById('format-text-color').onchange = function() {
                element.setAttribute('fill', this.value);
                updateElementData(element);
                saveStateToHistory();
            };
            
            // å¯¹é½
            document.getElementById('format-align-left').onclick = function() {
                element.setAttribute('text-anchor', 'start');
                updateElementData(element);
                saveStateToHistory();
            };
            
            document.getElementById('format-align-center').onclick = function() {
                element.setAttribute('text-anchor', 'middle');
                updateElementData(element);
                saveStateToHistory();
            };
            
            document.getElementById('format-align-right').onclick = function() {
                element.setAttribute('text-anchor', 'end');
                updateElementData(element);
                saveStateToHistory();
            };
        }
        
        // æ˜¾ç¤ºå›¾ç‰‡ä¸Šä¼ é¢æ¿
        function showImageUploadPanel() {
            const panel = document.getElementById('image-upload-panel');
            panel.style.display = 'block';
            
            // é‡ç½®è¡¨å•
            document.getElementById('image-upload-input').value = '';
            document.getElementById('image-url-input').value = '';
            document.getElementById('image-url-input').style.display = 'none';
            document.getElementById('image-preview-container').innerHTML = 'è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶';
            
            // éšè—å…¶ä»–é¢æ¿
            document.getElementById('book-add-panel').style.display = 'none';
            document.getElementById('md-convert-panel').style.display = 'none';
            document.getElementById('publish-panel').style.display = 'none';
        }
        
        // é¢„è§ˆå›¾ç‰‡
        function previewImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('image-preview-container').innerHTML = `<img src="${e.target.result}" alt="é¢„è§ˆå›¾">`;
                };
                reader.readAsDataURL(file);
            }
        }
        
        // ä¸Šä¼ å›¾ç‰‡
        function uploadImage() {
            const fileInput = document.getElementById('image-upload-input');
            const file = fileInput.files[0];
            if (!file) {
                alert('è¯·é€‰æ‹©ä¸€å¼ å›¾ç‰‡');
                return;
            }
            
            // è¿™é‡Œåº”è¯¥å®ç°çœŸå®çš„å›¾ç‰‡ä¸Šä¼ é€»è¾‘
            // ä¸ºäº†æ¼”ç¤ºï¼Œæˆ‘ä»¬ä½¿ç”¨æ–‡ä»¶çš„Data URL
            const reader = new FileReader();
            reader.onload = function(e) {
                const imageUrl = e.target.result;
                const width = parseInt(document.getElementById('image-width').value);
                const height = parseInt(document.getElementById('image-height').value);
                
                // åœ¨ç”»å¸ƒä¸Šåˆ›å»ºå›¾ç‰‡å…ƒç´ 
                createImageElementAtPosition(imageUrl, width, height);
                
                // éšè—é¢æ¿
                document.getElementById('image-upload-panel').style.display = 'none';
            };
            reader.readAsDataURL(file);
        }
        
        // ä½¿ç”¨å›¾ç‰‡URL
        function useImageUrl() {
            document.getElementById('image-upload-input').style.display = 'none';
            document.getElementById('image-url-input').style.display = 'block';
            
            // åˆ‡æ¢æŒ‰é’®åŠŸèƒ½
            if (document.getElementById('url-btn').textContent === 'ä½¿ç”¨URL') {
                document.getElementById('url-btn').textContent = 'ç¡®è®¤URL';
            } else {
                const imageUrl = document.getElementById('image-url-input').value.trim();
                if (!imageUrl) {
                    alert('è¯·è¾“å…¥å›¾ç‰‡URL');
                    return;
                }
                
                const width = parseInt(document.getElementById('image-width').value);
                const height = parseInt(document.getElementById('image-height').value);
                
                // åœ¨ç”»å¸ƒä¸Šåˆ›å»ºå›¾ç‰‡å…ƒç´ 
                createImageElementAtPosition(imageUrl, width, height);
                
                // éšè—é¢æ¿
                document.getElementById('image-upload-panel').style.display = 'none';
            }
        }
        
        // åœ¨æŒ‡å®šä½ç½®åˆ›å»ºå›¾ç‰‡å…ƒç´ 
        function createImageElementAtPosition(src, width, height) {
            const svg = document.getElementById('editor-svg');
            
            // åˆ›å»ºå›¾ç‰‡å…ƒç´ 
            const image = document.createElementNS('http://www.w3.org/2000/svg', 'image');
            image.setAttribute('x', '50');
            image.setAttribute('y', '150');
            image.setAttribute('width', width);
            image.setAttribute('height', height);
            image.setAttribute('href', src);
            image.classList.add('element');
            
            // å›¾ç‰‡ç‚¹å‡»äº‹ä»¶
            image.addEventListener('click', function(e) {
                e.stopPropagation();
                selectElement(image);
                
                // è¯¢é—®æ˜¯å¦æ›´æ¢å›¾ç‰‡
                const change = confirm('æ˜¯å¦è¦æ›´æ¢è¿™å¼ å›¾ç‰‡ï¼Ÿ');
                if (change) {
                    const newSrc = prompt('è¯·è¾“å…¥æ–°çš„å›¾ç‰‡URL:', image.getAttribute('href'));
                    if (newSrc) {
                        image.setAttribute('href', newSrc);
                        updateElementData(image);
                        saveStateToHistory();
                    }
                }
            });
            
            svg.appendChild(image);
            
            // æ·»åŠ åˆ°çŠ¶æ€ä¸­
            editorState.elements.push({
                id: Date.now(),
                type: 'image',
                element: image,
                content: src,
                x: 50,
                y: 150,
                width: width,
                height: height
            });
            
            saveStateToHistory();
        }
        
        // æ˜¾ç¤ºå›¾ä¹¦æ·»åŠ é¢æ¿
        function showBookAddPanel() {
            const panel = document.getElementById('book-add-panel');
            panel.style.display = 'block';
            
            // é‡ç½®è¡¨å•
            document.getElementById('book-cover-url').value = '';
            document.getElementById('book-title').value = '';
            document.getElementById('book-author').value = '';
            document.getElementById('book-desc').value = '';
            
            // éšè—å…¶ä»–é¢æ¿
            document.getElementById('image-upload-panel').style.display = 'none';
            document.getElementById('md-convert-panel').style.display = 'none';
            document.getElementById('publish-panel').style.display = 'none';
        }
        
        // éšè—å›¾ä¹¦æ·»åŠ é¢æ¿
        function hideBookAddPanel() {
            document.getElementById('book-add-panel').style.display = 'none';
        }
        
        // æ·»åŠ å›¾ä¹¦
        function addBook() {
            const coverUrl = document.getElementById('book-cover-url').value.trim();
            const title = document.getElementById('book-title').value.trim();
            const author = document.getElementById('book-author').value.trim();
            const desc = document.getElementById('book-desc').value.trim();
            
            if (!title) {
                alert('è¯·è¾“å…¥å›¾ä¹¦åç§°');
                return;
            }
            
            // åˆ›å»ºå›¾ä¹¦å…ƒç´ 
            createBookElement(coverUrl, title, author, desc);
            
            // éšè—é¢æ¿
            hideBookAddPanel();
        }
        
        // åˆ›å»ºå›¾ä¹¦å…ƒç´ 
        function createBookElement(coverUrl, title, author, desc) {
            const svg = document.getElementById('editor-svg');
            
            // åˆ›å»ºå›¾ä¹¦ä¿¡æ¯ç»„åˆå…ƒç´ 
            const bookGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            bookGroup.setAttribute('class', 'element');
            bookGroup.setAttribute('data-type', 'book');
            
            // å›¾ä¹¦å°é¢å›¾ç‰‡
            if (coverUrl) {
                const coverImage = document.createElementNS('http://www.w3.org/2000/svg', 'image');
                coverImage.setAttribute('x', '50');
                coverImage.setAttribute('y', '150');
                coverImage.setAttribute('width', '80');
                coverImage.setAttribute('height', '100');
                coverImage.setAttribute('href', coverUrl);
                bookGroup.appendChild(coverImage);
            }
            
            // å›¾ä¹¦æ ‡é¢˜
            const titleText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            titleText.setAttribute('x', coverUrl ? '140' : '50');
            titleText.setAttribute('y', coverUrl ? '160' : '150');
            titleText.setAttribute('font-family', 'Microsoft YaHei');
            titleText.setAttribute('font-size', '16');
            titleText.setAttribute('font-weight', 'bold');
            titleText.setAttribute('fill', '#000000');
            titleText.setAttribute('contenteditable', 'true');
            titleText.textContent = title;
            bookGroup.appendChild(titleText);
            
            // ä½œè€…ä¿¡æ¯
            if (author) {
                const authorText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                authorText.setAttribute('x', coverUrl ? '140' : '50');
                authorText.setAttribute('y', coverUrl ? '185' : '180');
                authorText.setAttribute('font-family', 'Microsoft YaHei');
                authorText.setAttribute('font-size', '14');
                authorText.setAttribute('fill', '#6c757d');
                authorText.setAttribute('contenteditable', 'true');
                authorText.textContent = `ä½œè€…: ${author}`;
                bookGroup.appendChild(authorText);
            }
            
            // å›¾ä¹¦ç®€ä»‹
            if (desc) {
                const descText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                descText.setAttribute('x', coverUrl ? '140' : '50');
                descText.setAttribute('y', coverUrl ? '210' : '210');
                descText.setAttribute('font-family', 'Microsoft YaHei');
                descText.setAttribute('font-size', '14');
                descText.setAttribute('fill', '#495057');
                descText.setAttribute('contenteditable', 'true');
                descText.textContent = desc;
                bookGroup.appendChild(descText);
            }
            
            // æ·»åŠ ç‚¹å‡»é€‰ä¸­äº‹ä»¶
            bookGroup.addEventListener('click', function(e) {
                e.stopPropagation();
                selectElement(bookGroup);
            });
            
            svg.appendChild(bookGroup);
            
            // æ·»åŠ åˆ°çŠ¶æ€ä¸­
            editorState.elements.push({
                id: Date.now(),
                type: 'book',
                element: bookGroup,
                content: JSON.stringify({ coverUrl, title, author, desc }),
                x: 50,
                y: 150
            });
            
            saveStateToHistory();
        }
        
        // æ˜¾ç¤ºMDè½¬æ¢é¢æ¿
        function showMdConvertPanel() {
            const panel = document.getElementById('md-convert-panel');
            panel.style.display = 'block';
            
            // é‡ç½®è¡¨å•
            document.getElementById('md-input').value = '';
            document.getElementById('md-preview').style.display = 'none';
            
            // éšè—å…¶ä»–é¢æ¿
            document.getElementById('image-upload-panel').style.display = 'none';
            document.getElementById('book-add-panel').style.display = 'none';
            document.getElementById('publish-panel').style.display = 'none';
        }
        
        // éšè—MDè½¬æ¢é¢æ¿
        function hideMdConvertPanel() {
            document.getElementById('md-convert-panel').style.display = 'none';
        }
        
        // é¢„è§ˆMarkdown
        function previewMarkdown() {
            const mdText = document.getElementById('md-input').value;
            if (mdText.trim() === '') {
                document.getElementById('md-preview').style.display = 'none';
                return;
            }
            
            const html = parseMarkdown(mdText);
            document.getElementById('md-preview').innerHTML = html;
            document.getElementById('md-preview').style.display = 'block';
        }
        
        // è½¬æ¢Markdown
        function convertMarkdown() {
            const mdText = document.getElementById('md-input').value;
            if (mdText.trim() === '') {
                alert('è¯·è¾“å…¥Markdownæ–‡æœ¬');
                return;
            }
            
            // è§£æMarkdownå¹¶åˆ›å»ºç›¸åº”å…ƒç´ 
            createElementsFromMarkdown(mdText);
            
            // éšè—é¢æ¿
            hideMdConvertPanel();
        }
        
        // è§£æMarkdownæ–‡æœ¬
        function parseMarkdown(text) {
            let html = text;
            
            // æ ‡é¢˜ (æ”¯æŒ #, ##, ###)
            html = html.replace(/^### (.*$)/gm, '<h3>$1</h3>');
            html = html.replace(/^## (.*$)/gm, '<h2>$1</h2>');
            html = html.replace(/^# (.*$)/gm, '<h1>$1</h1>');
            
            // ç²—ä½“ **text** æˆ– __text__
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/__(.*?)__/g, '<strong>$1</strong>');
            
            // æ–œä½“ *text* æˆ– _text_
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
            html = html.replace(/_(.*?)_/g, '<em>$1</em>');
            
            // è¡Œå†…ä»£ç  `code`
            html = html.replace(/`(.*?)`/g, '<code>$1</code>');
            
            // å¼•ç”¨å— > quote
            html = html.replace(/^> (.*$)/gm, '<blockquote>$1</blockquote>');
            
            // æ¢è¡Œ
            html = html.replace(/\n/g, '<br>');
            
            // æ®µè½ - å°†è¿ç»­çš„<br>åˆ†ç»„ä¸ºæ®µè½
            html = html.replace(/(<br>){2,}/g, '</p><p>');
            html = '<p>' + html + '</p>';
            html = html.replace(/<p><\/p>/g, '');
            
            return html;
        }
        
        // ä»Markdownåˆ›å»ºå…ƒç´ 
        function createElementsFromMarkdown(mdText) {
            const lines = mdText.split('\n');
            const svg = document.getElementById('editor-svg');
            let currentY = 80;
            
            lines.forEach(line => {
                if (line.startsWith('# ')) {
                    // ä¸€çº§æ ‡é¢˜
                    const title = createTitleElement();
                    title.setAttribute('x', '50');
                    title.setAttribute('y', currentY);
                    title.textContent = line.substring(2);
                    svg.appendChild(title);
                    
                    editorState.elements.push({
                        id: Date.now(),
                        type: 'title',
                        element: title,
                        content: line.substring(2),
                        x: 50,
                        y: currentY
                    });
                    
                    currentY += 60;
                } else if (line.startsWith('## ')) {
                    // äºŒçº§æ ‡é¢˜
                    const title = createTitleElement();
                    title.setAttribute('x', '50');
                    title.setAttribute('y', currentY);
                    title.setAttribute('font-size', '20');
                    title.textContent = line.substring(3);
                    svg.appendChild(title);
                    
                    editorState.elements.push({
                        id: Date.now(),
                        type: 'title',
                        element: title,
                        content: line.substring(3),
                        x: 50,
                        y: currentY
                    });
                    
                    currentY += 50;
                } else if (line.startsWith('### ')) {
                    // ä¸‰çº§æ ‡é¢˜
                    const title = createTitleElement();
                    title.setAttribute('x', '50');
                    title.setAttribute('y', currentY);
                    title.setAttribute('font-size', '18');
                    title.textContent = line.substring(4);
                    svg.appendChild(title);
                    
                    editorState.elements.push({
                        id: Date.now(),
                        type: 'title',
                        element: title,
                        content: line.substring(4),
                        x: 50,
                        y: currentY
                    });
                    
                    currentY += 40;
                } else if (line.startsWith('> ')) {
                    // å¼•ç”¨å—
                    const quote = createQuoteElement();
                    const textEl = quote.querySelector('text');
                    textEl.textContent = line.substring(2);
                    textEl.setAttribute('x', '60');
                    textEl.setAttribute('y', currentY + 40);
                    
                    const rectEl = quote.querySelector('rect');
                    rectEl.setAttribute('x', '40');
                    rectEl.setAttribute('y', currentY);
                    rectEl.setAttribute('width', '500');
                    rectEl.setAttribute('height', '100');
                    
                    svg.appendChild(quote);
                    
                    editorState.elements.push({
                        id: Date.now(),
                        type: 'blockquote',
                        element: quote,
                        content: line.substring(2),
                        x: 40,
                        y: currentY
                    });
                    
                    currentY += 120;
                } else if (line.trim() !== '') {
                    // æ™®é€šæ–‡æœ¬ - å¤„ç†ç²—ä½“ã€æ–œä½“ç­‰
                    const text = createTextElement();
                    text.setAttribute('x', '50');
                    text.setAttribute('y', currentY);
                    
                    // è§£æç²—ä½“å’Œæ–œä½“
                    let processedLine = line;
                    processedLine = processedLine.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                    processedLine = processedLine.replace(/\*(.*?)\*/g, '<em>$1</em>');
                    
                    text.textContent = processedLine;
                    svg.appendChild(text);
                    
                    editorState.elements.push({
                        id: Date.now(),
                        type: 'text',
                        element: text,
                        content: processedLine,
                        x: 50,
                        y: currentY
                    });
                    
                    currentY += 30;
                }
            });
            
            saveStateToHistory();
        }
        
        // æ˜¾ç¤ºå‘å¸ƒé¢æ¿
        function showPublishPanel() {
            document.getElementById('publish-panel').style.display = 'block';
            
            // ä»å½“å‰ç”»å¸ƒå†…å®¹ä¸­é¢„å¡«å……ä¸€äº›å­—æ®µ
            const firstTitleElement = editorState.elements.find(el => el.type === 'title');
            if (firstTitleElement) {
                document.getElementById('article-title').value = firstTitleElement.content;
            }
            
            // ä»å½“å‰ç”»å¸ƒå†…å®¹ç”Ÿæˆæ‘˜è¦
            const textElements = editorState.elements.filter(el => el.type === 'text');
            if (textElements.length > 0) {
                const firstText = textElements[0].content;
                document.getElementById('article-summary').value = firstText.substring(0, 100) + '...';
            }
            
            // éšè—å…¶ä»–é¢æ¿
            document.getElementById('image-upload-panel').style.display = 'none';
            document.getElementById('book-add-panel').style.display = 'none';
            document.getElementById('md-convert-panel').style.display = 'none';
        }
        
        // éšè—å‘å¸ƒé¢æ¿
        function hidePublishPanel() {
            document.getElementById('publish-panel').style.display = 'none';
        }
        
        // å‘å¸ƒåˆ°å¾®ä¿¡å…¬ä¼—å·
        function publishToWeChat() {
            const title = document.getElementById('article-title').value.trim();
            const author = document.getElementById('article-author').value.trim();
            const summary = document.getElementById('article-summary').value.trim();
            const cover = document.getElementById('article-cover').value.trim();
            const isOriginal = document.getElementById('is-original').checked;
            
            if (!title) {
                alert('è¯·è¾“å…¥æ–‡ç« æ ‡é¢˜');
                return;
            }
            
            // å°†ç”»å¸ƒå†…å®¹è½¬æ¢ä¸ºå¾®ä¿¡å…¬ä¼—å·ç¼–è¾‘å™¨å¯ä»¥ç†è§£çš„æ ¼å¼
            const content = convertCanvasToWeChatFormat();
            
            // æ˜¾ç¤ºå‘å¸ƒç¡®è®¤ä¿¡æ¯
            const confirmMsg = `å³å°†å‘å¸ƒæ–‡ç« ï¼š
            \næ ‡é¢˜: ${title}
ä½œè€…: ${author}
æ‘˜è¦: ${summary}
å°é¢å›¾: ${cover || 'æ— '}
æ˜¯å¦åŸåˆ›: ${isOriginal ? 'æ˜¯' : 'å¦'}
            \nå†…å®¹é¢„è§ˆ:\n${content.substring(0, 200)}...`;
            
            if (confirm(confirmMsg)) {
                // è¿™é‡Œå°†é›†æˆåŸå§‹çš„å¾®ä¿¡å…¬ä¼—å·å‘å¸ƒä»£ç 
                // ä¸ºäº†æ¼”ç¤ºï¼Œæˆ‘ä»¬ä½¿ç”¨æ¨¡æ‹Ÿå‡½æ•°
                simulateWeChatPublish(title, author, summary, cover, isOriginal, content);
            }
        }
        
        // æ¨¡æ‹Ÿå¾®ä¿¡å…¬ä¼—å·å‘å¸ƒ
        function simulateWeChatPublish(title, author, summary, cover, isOriginal, content) {
            // æ˜¾ç¤ºå‘å¸ƒçŠ¶æ€
            const statusDiv = document.createElement('div');
            statusDiv.id = 'publish-status';
            statusDiv.innerHTML = '<div style="position: fixed; top: 20px; right: 20px; background: #17a2b8; color: white; padding: 15px; border-radius: 5px; z-index: 10000; font-family: Microsoft YaHei;">æ­£åœ¨å‡†å¤‡å‘å¸ƒ...</div>';
            document.body.appendChild(statusDiv);
            
            // å°†æ–‡ç« æ•°æ®å­˜å‚¨åœ¨ localStorage ä¸­ï¼Œä»¥ä¾¿ Python è„šæœ¬å¯ä»¥è®¿é—®
            const articleData = {
                title: title,
                author: author,
                summary: summary,
                cover: cover,
                isOriginal: isOriginal,
                content: content,
                timestamp: new Date().getTime()
            };
            
            localStorage.setItem('wechatArticleData', JSON.stringify(articleData));
            
            // æ¨¡æ‹Ÿå‘å¸ƒè¿‡ç¨‹
            setTimeout(() => {
                document.getElementById('publish-status').innerHTML = '<div style="position: fixed; top: 20px; right: 20px; background: #28a745; color: white; padding: 15px; border-radius: 5px; z-index: 10000; font-family: Microsoft YaHei;">å‘å¸ƒæˆåŠŸï¼<br>æ ‡é¢˜: ' + title + '</div>';
                
                // 3ç§’åç§»é™¤çŠ¶æ€æç¤º
                setTimeout(() => {
                    if (document.getElementById('publish-status')) {
                        document.body.removeChild(document.getElementById('publish-status'));
                    }
                }, 3000);
                
                console.log('å‘å¸ƒæ–‡ç« åˆ°å¾®ä¿¡å…¬ä¼—å·:', {
                    title,
                    author,
                    summary,
                    cover,
                    isOriginal,
                    content
                });
                
                // éšè—å‘å¸ƒé¢æ¿
                hidePublishPanel();
            }, 2000);
        }
        
        // è¿‡æ»¤ç»„ä»¶å’Œæ¨¡æ¿
        function filterComponentsAndTemplates(searchTerm) {
            // è¿‡æ»¤ç»„ä»¶
            document.querySelectorAll('.component-item').forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
            
            // è¿‡æ»¤é»˜è®¤æ¨¡æ¿
            document.querySelectorAll('.template-item').forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
            
            // è¿‡æ»¤å·²ä¿å­˜çš„æ¨¡æ¿
            document.querySelectorAll('.saved-template-item').forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        // åˆ›å»ºå…ƒç´ 
        function createElement(type) {
            const svg = document.getElementById('editor-svg');
            let element;
            
            switch(type) {
                case 'title':
                    element = createTitleElement();
                    break;
                case 'text':
                    element = createTextElement();
                    break;
                case 'image':
                    element = createImageElement();
                    break;
                case 'divider':
                    element = createDividerElement();
                    break;
                case 'blockquote':
                    element = createQuoteElement();
                    break;
                case 'list':
                    element = createListElement();
                    break;
                case 'highlight':
                    element = createHighlightElement();
                    break;
                default:
                    return;
            }
            
            // æ·»åŠ ç‚¹å‡»é€‰ä¸­äº‹ä»¶
            element.addEventListener('click', function(e) {
                e.stopPropagation();
                selectElement(element);
            });
            
            svg.appendChild(element);
            editorState.elements.push({
                id: Date.now(),
                type: type,
                element: element,
                content: element.textContent || element.getAttribute('href') || '',
                x: parseInt(element.getAttribute('x')) || 0,
                y: parseInt(element.getAttribute('y')) || 0
            });
            
            saveStateToHistory();
        }
        
        // åˆ›å»ºé«˜äº®æ–‡æœ¬å…ƒç´ 
        function createHighlightElement() {
            const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            text.setAttribute('x', '50');
            text.setAttribute('y', '130');
            text.setAttribute('font-family', 'Microsoft YaHei');
            text.setAttribute('font-size', '16');
            text.setAttribute('fill', '#ffffff');
            text.setAttribute('text-anchor', 'start');
            text.setAttribute('contenteditable', 'true');
            text.textContent = 'é«˜äº®æ–‡æœ¬';
            text.classList.add('element');
            
            // æ·»åŠ èƒŒæ™¯çŸ©å½¢
            const bgRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            bgRect.setAttribute('x', '45');
            bgRect.setAttribute('y', '115');
            bgRect.setAttribute('width', '100');
            bgRect.setAttribute('height', '25');
            bgRect.setAttribute('fill', '#ff6b6b');
            bgRect.setAttribute('rx', '4');
            bgRect.setAttribute('ry', '4');
            
            // åˆ›å»ºç»„ä»¥åŒ…å«çŸ©å½¢èƒŒæ™¯å’Œæ–‡æœ¬
            const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            g.appendChild(bgRect);
            g.appendChild(text);
            g.classList.add('element');
            
            // æ·»åŠ äº‹ä»¶åˆ°ç»„
            g.addEventListener('click', function(e) {
                e.stopPropagation();
                selectElement(g);
            });
            
            // æ–‡æœ¬ç¼–è¾‘äº‹ä»¶
            text.addEventListener('blur', function() {
                // æ›´æ–°èƒŒæ™¯çŸ©å½¢å¤§å°
                const bbox = text.getBBox();
                bgRect.setAttribute('x', bbox.x - 5);
                bgRect.setAttribute('y', bbox.y - 5);
                bgRect.setAttribute('width', bbox.width + 10);
                bgRect.setAttribute('height', bbox.height + 10);
                
                updateElementData(g);
            });
            
            // é”®ç›˜äº‹ä»¶
            text.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const newText = createTextElement();
                    newText.setAttribute('x', text.getAttribute('x'));
                    newText.setAttribute('y', (parseInt(text.getAttribute('y')) + 30).toString());
                    newText.textContent = '';
                    newText.focus();
                    
                    const svg = document.getElementById('editor-svg');
                    svg.appendChild(newText);
                    editorState.elements.push({
                        id: Date.now(),
                        type: 'text',
                        element: newText,
                        content: '',
                        x: parseInt(newText.getAttribute('x')),
                        y: parseInt(newText.getAttribute('y'))
                    });
                    
                    selectElement(newText);
                    saveStateToHistory();
                }
            });
            
            return g;
        }
        
        // åˆ›å»ºæ ‡é¢˜å…ƒç´ 
        function createTitleElement() {
            const title = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            title.setAttribute('x', '50');
            title.setAttribute('y', '80');
            title.setAttribute('font-family', 'Microsoft YaHei');
            title.setAttribute('font-size', '24');
            title.setAttribute('font-weight', 'bold');
            title.setAttribute('fill', '#000000');
            title.setAttribute('text-anchor', 'start');
            title.setAttribute('contenteditable', 'true');
            title.textContent = 'æ ‡é¢˜';
            title.classList.add('element');
            
            title.addEventListener('blur', function() {
                updateElementData(title);
            });
            
            // æ·»åŠ é”®ç›˜äº‹ä»¶å¤„ç†
            title.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const newText = createTextElement();
                    newText.setAttribute('x', title.getAttribute('x'));
                    newText.setAttribute('y', (parseInt(title.getAttribute('y')) + 50).toString());
                    newText.textContent = '';
                    newText.focus();
                    
                    const svg = document.getElementById('editor-svg');
                    svg.appendChild(newText);
                    editorState.elements.push({
                        id: Date.now(),
                        type: 'text',
                        element: newText,
                        content: '',
                        x: parseInt(newText.getAttribute('x')),
                        y: parseInt(newText.getAttribute('y'))
                    });
                    
                    selectElement(newText);
                    saveStateToHistory();
                }
            });
            
            return title;
        }
        
        // åˆ›å»ºæ–‡æœ¬å…ƒç´ 
        function createTextElement() {
            const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            text.setAttribute('x', '50');
            text.setAttribute('y', '130');
            text.setAttribute('font-family', 'Microsoft YaHei');
            text.setAttribute('font-size', '16');
            text.setAttribute('fill', '#000000');
            text.setAttribute('text-anchor', 'start');
            text.setAttribute('contenteditable', 'true');
            text.textContent = 'ç‚¹å‡»ç¼–è¾‘æ–‡æœ¬';
            text.classList.add('element');
            
            // æ·»åŠ æ–‡æœ¬ç¼–è¾‘å®Œæˆäº‹ä»¶
            text.addEventListener('blur', function() {
                updateElementData(text);
            });
            
            // æ·»åŠ é”®ç›˜äº‹ä»¶å¤„ç†
            text.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    // åˆ›å»ºæ–°æ–‡æœ¬å…ƒç´ 
                    const newText = createTextElement();
                    newText.setAttribute('x', text.getAttribute('x'));
                    newText.setAttribute('y', (parseInt(text.getAttribute('y')) + 30).toString());
                    newText.textContent = '';
                    newText.focus();
                    
                    const svg = document.getElementById('editor-svg');
                    svg.appendChild(newText);
                    editorState.elements.push({
                        id: Date.now(),
                        type: 'text',
                        element: newText,
                        content: '',
                        x: parseInt(newText.getAttribute('x')),
                        y: parseInt(newText.getAttribute('y'))
                    });
                    
                    selectElement(newText);
                    saveStateToHistory();
                }
            });
            
            return text;
        }
        
        // åˆ›å»ºåˆ—è¡¨å…ƒç´ 
        function createListElement() {
            const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            g.classList.add('element');
            
            // åˆ›å»ºåˆ—è¡¨é¡¹
            for (let i = 0; i < 3; i++) {
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', '50');
                text.setAttribute('y', (130 + i * 30).toString());
                text.setAttribute('font-family', 'Microsoft YaHei');
                text.setAttribute('font-size', '16');
                text.setAttribute('fill', '#000000');
                text.setAttribute('contenteditable', 'true');
                
                if (i === 0) {
                    text.textContent = 'â€¢ åˆ—è¡¨é¡¹ 1';
                } else {
                    text.textContent = 'â€¢ åˆ—è¡¨é¡¹ ' + (i + 1);
                }
                
                g.appendChild(text);
            }
            
            // æ·»åŠ ç‚¹å‡»é€‰ä¸­äº‹ä»¶åˆ°ç»„ä¸­çš„æ‰€æœ‰æ–‡æœ¬
            const texts = g.querySelectorAll('text');
            texts.forEach(text => {
                text.addEventListener('blur', function() {
                    updateElementData(g);
                });
                
                text.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const nextY = parseInt(text.getAttribute('y')) + 30;
                        const newText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                        newText.setAttribute('x', text.getAttribute('x'));
                        newText.setAttribute('y', nextY.toString());
                        newText.setAttribute('font-family', 'Microsoft YaHei');
                        newText.setAttribute('font-size', '16');
                        newText.setAttribute('fill', '#000000');
                        newText.setAttribute('contenteditable', 'true');
                        newText.textContent = 'â€¢ æ–°åˆ—è¡¨é¡¹';
                        newText.focus();
                        
                        g.appendChild(newText);
                        editorState.elements.push({
                            id: Date.now(),
                            type: 'list-item',
                            element: newText,
                            content: 'â€¢ æ–°åˆ—è¡¨é¡¹',
                            x: parseInt(newText.getAttribute('x')),
                            y: parseInt(newText.getAttribute('y'))
                        });
                        
                        updateElementData(g);
                        saveStateToHistory();
                    }
                });
            });
            
            return g;
        }
        
        // åˆ›å»ºå›¾ç‰‡å…ƒç´ 
        function createImageElement() {
            const image = document.createElementNS('http://www.w3.org/2000/svg', 'image');
            image.setAttribute('x', '50');
            image.setAttribute('y', '150');
            image.setAttribute('width', '300');
            image.setAttribute('height', '200');
            image.setAttribute('href', 'https://via.placeholder.com/300x200.png');
            image.classList.add('element');
            
            // å›¾ç‰‡ç‚¹å‡»äº‹ä»¶ - æ›´æ¢å›¾ç‰‡
            image.addEventListener('click', function(e) {
                e.stopPropagation();
                selectElement(image);
                const newSrc = prompt('è¯·è¾“å…¥å›¾ç‰‡URL:', image.getAttribute('href'));
                if (newSrc) {
                    image.setAttribute('href', newSrc);
                    updateElementData(image);
                    saveStateToHistory();
                }
            });
            
            return image;
        }
        
        // åˆ›å»ºåˆ†å‰²çº¿å…ƒç´ 
        function createDividerElement() {
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('x1', '50');
            line.setAttribute('y1', '200');
            line.setAttribute('x2', '700');
            line.setAttribute('y2', '200');
            line.setAttribute('stroke', '#000000');
            line.setAttribute('stroke-width', '1');
            line.classList.add('element');
            
            return line;
        }
        
        // åˆ›å»ºå¼•ç”¨å—å…ƒç´ 
        function createQuoteElement() {
            const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            g.classList.add('element');
            
            // åˆ›å»ºå¼•ç”¨èƒŒæ™¯
            const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            rect.setAttribute('x', '40');
            rect.setAttribute('y', '220');
            rect.setAttribute('width', '500');
            rect.setAttribute('height', '100');
            rect.setAttribute('fill', '#f8f9fa');
            rect.setAttribute('stroke', '#dee2e6');
            rect.setAttribute('stroke-width', '1');
            rect.setAttribute('rx', '4');
            rect.setAttribute('ry', '4');
            
            // åˆ›å»ºå¼•ç”¨æ–‡æœ¬
            const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            text.setAttribute('x', '60');
            text.setAttribute('y', '260');
            text.setAttribute('font-family', 'Microsoft YaHei');
            text.setAttribute('font-size', '14');
            text.setAttribute('fill', '#6c757d');
            text.setAttribute('contenteditable', 'true');
            text.textContent = 'è¿™æ˜¯å¼•ç”¨å—å†…å®¹ï¼Œç”¨äºçªå‡ºæ˜¾ç¤ºé‡è¦è§‚ç‚¹æˆ–å¼•ç”¨ä»–äººçš„è¯è¯­ã€‚';
            
            g.appendChild(rect);
            g.appendChild(text);
            
            text.addEventListener('blur', function() {
                updateElementData(g);
            });
            
            // æ·»åŠ é”®ç›˜äº‹ä»¶å¤„ç†
            text.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const newText = createTextElement();
                    newText.setAttribute('x', text.getAttribute('x'));
                    newText.setAttribute('y', (parseInt(text.getAttribute('y')) + 30).toString());
                    newText.textContent = '';
                    newText.focus();
                    
                    const svg = document.getElementById('editor-svg');
                    svg.appendChild(newText);
                    editorState.elements.push({
                        id: Date.now(),
                        type: 'text',
                        element: newText,
                        content: '',
                        x: parseInt(newText.getAttribute('x')),
                        y: parseInt(newText.getAttribute('y'))
                    });
                    
                    selectElement(newText);
                    saveStateToHistory();
                }
            });
            
            return g;
        }
        
        // é€‰æ‹©å…ƒç´ 
        function selectElement(element) {
            // æ¸…é™¤ä¹‹å‰çš„é€‰æ‹©
            document.querySelectorAll('.element').forEach(el => {
                el.classList.remove('selected');
            });
            
            // é€‰ä¸­å½“å‰å…ƒç´ 
            element.classList.add('selected');
            editorState.selectedElement = element;
        }
        
        // æ›´æ–°å…ƒç´ æ•°æ®
        function updateElementData(element) {
            const elementObj = editorState.elements.find(el => {
                if (el.element === element) return true;
                // å¯¹äºç»„åˆå…ƒç´ ï¼Œæ£€æŸ¥å…¶å­å…ƒç´ 
                if (element.tagName === 'g' && el.element.tagName === 'g') {
                    return element.isSameNode(el.element);
                }
                return false;
            });
            
            if (elementObj) {
                if (element.tagName === 'image') {
                    elementObj.content = element.getAttribute('href');
                    elementObj.x = parseInt(element.getAttribute('x')) || 0;
                    elementObj.y = parseInt(element.getAttribute('y')) || 0;
                    elementObj.width = parseInt(element.getAttribute('width')) || 300;
                    elementObj.height = parseInt(element.getAttribute('height')) || 200;
                } else if (element.tagName === 'g' && element.getAttribute('data-type') === 'book') {
                    // å›¾ä¹¦å…ƒç´ çš„å¤„ç†
                    const coverImage = element.querySelector('image');
                    const titleText = element.querySelector('text');
                    const authorText = element.querySelectorAll('text')[1];
                    const descText = element.querySelectorAll('text')[2];
                    
                    const bookData = {
                        coverUrl: coverImage ? coverImage.getAttribute('href') : '',
                        title: titleText ? titleText.textContent : '',
                        author: authorText ? authorText.textContent.replace('ä½œè€…: ', '') : '',
                        desc: descText ? descText.textContent : ''
                    };
                    
                    elementObj.content = JSON.stringify(bookData);
                    elementObj.x = parseInt(element.getAttribute('x')) || 0;
                    elementObj.y = parseInt(element.getAttribute('y')) || 0;
                } else if (element.tagName === 'g') {
                    // å¯¹äºç»„åˆå…ƒç´ ï¼Œè·å–ç¬¬ä¸€ä¸ªæ–‡æœ¬å­å…ƒç´ çš„å†…å®¹
                    const textEl = element.querySelector('text');
                    elementObj.content = textEl ? textEl.textContent : '';
                    elementObj.x = parseInt(textEl ? textEl.getAttribute('x') : element.querySelector('rect').getAttribute('x')) || 0;
                    elementObj.y = parseInt(textEl ? textEl.getAttribute('y') : element.querySelector('rect').getAttribute('y')) || 0;
                } else {
                    elementObj.content = element.textContent || '';
                    elementObj.x = parseInt(element.getAttribute('x')) || 0;
                    elementObj.y = parseInt(element.getAttribute('y')) || 0;
                }
            }
        }
        
        // ä¿å­˜çŠ¶æ€åˆ°å†å²è®°å½•
        function saveStateToHistory() {
            // æˆªæ–­å†å²è®°å½•ï¼ˆæ’¤é”€åæ·»åŠ æ–°æ“ä½œæ—¶ï¼Œæ¸…é™¤åç»­å†å²ï¼‰
            editorState.history = editorState.history.slice(0, editorState.historyIndex + 1);
            
            // ä¿å­˜å½“å‰çŠ¶æ€
            const currentState = JSON.parse(JSON.stringify({
                elements: editorState.elements.map(el => ({
                    ...el,
                    element: null // ä¸ä¿å­˜DOMå…ƒç´ å¼•ç”¨
                }))
            }));
            
            editorState.history.push(currentState);
            editorState.historyIndex = editorState.history.length - 1;
        }
        
        // æ’¤é”€åŠŸèƒ½
        function undo() {
            if (editorState.historyIndex > 0) {
                editorState.historyIndex--;
                restoreStateFromHistory();
            }
        }
        
        // é‡åšåŠŸèƒ½
        function redo() {
            if (editorState.historyIndex < editorState.history.length - 1) {
                editorState.historyIndex++;
                restoreStateFromHistory();
            }
        }
        
        // ä»å†å²è®°å½•æ¢å¤çŠ¶æ€
        function restoreStateFromHistory() {
            const state = editorState.history[editorState.historyIndex];
            if (!state) return;
            
            clearCanvasWithoutHistory();
            
            const svg = document.getElementById('editor-svg');
            editorState.elements = [];
            
            state.elements.forEach(elData => {
                let element;
                
                switch(elData.type) {
                    case 'title':
                        element = createTitleElement();
                        element.setAttribute('x', elData.x || 50);
                        element.setAttribute('y', elData.y || 80);
                        element.setAttribute('font-size', elData.fontSize || '24');
                        if (elData.fontWeight) element.setAttribute('font-weight', elData.fontWeight);
                        element.textContent = elData.content || 'æ ‡é¢˜';
                        break;
                    case 'text':
                        element = createTextElement();
                        element.setAttribute('x', elData.x || 50);
                        element.setAttribute('y', elData.y || 130);
                        element.setAttribute('font-size', elData.fontSize || '16');
                        if (elData.fontWeight) element.setAttribute('font-weight', elData.fontWeight);
                        if (elData.fontStyle) element.setAttribute('font-style', elData.fontStyle);
                        if (elData.fill) element.setAttribute('fill', elData.fill);
                        if (elData.textAnchor) element.setAttribute('text-anchor', elData.textAnchor);
                        element.textContent = elData.content || 'ç‚¹å‡»ç¼–è¾‘æ–‡æœ¬';
                        break;
                    case 'image':
                        element = createImageElement();
                        element.setAttribute('x', elData.x || 50);
                        element.setAttribute('y', elData.y || 150);
                        element.setAttribute('width', elData.width || '300');
                        element.setAttribute('height', elData.height || '200');
                        element.setAttribute('href', elData.content || 'https://via.placeholder.com/300x200.png');
                        break;
                    case 'divider':
                        element = createDividerElement();
                        element.setAttribute('x1', elData.x1 || 50);
                        element.setAttribute('y1', elData.y1 || 200);
                        element.setAttribute('x2', elData.x2 || 700);
                        element.setAttribute('y2', elData.y2 || 200);
                        break;
                    case 'blockquote':
                        element = createQuoteElement();
                        const rect = element.querySelector('rect');
                        const text = element.querySelector('text');
                        const y = elData.y || 250;
                        rect.setAttribute('x', elData.x || 40);
                        rect.setAttribute('y', y - 30);
                        rect.setAttribute('width', '500');
                        rect.setAttribute('height', '100');
                        text.setAttribute('x', (elData.x + 20) || 60);
                        text.setAttribute('y', y);
                        text.setAttribute('font-size', elData.fontSize || '14');
                        text.textContent = elData.content || 'è¿™æ˜¯å¼•ç”¨å—å†…å®¹ï¼Œç”¨äºçªå‡ºæ˜¾ç¤ºé‡è¦è§‚ç‚¹æˆ–å¼•ç”¨ä»–äººçš„è¯è¯­ã€‚';
                        break;
                    case 'highlight':
                        element = createHighlightElement();
                        const g = element;
                        const bgRect = g.querySelector('rect');
                        const textEl = g.querySelector('text');
                        textEl.setAttribute('x', elData.x || 50);
                        textEl.setAttribute('y', elData.y || 130);
                        textEl.setAttribute('font-size', elData.fontSize || '16');
                        if (elData.fontWeight) textEl.setAttribute('font-weight', elData.fontWeight);
                        if (elData.fontStyle) textEl.setAttribute('font-style', elData.fontStyle);
                        if (elData.fill) textEl.setAttribute('fill', elData.fill);
                        textEl.textContent = elData.content || 'é«˜äº®æ–‡æœ¬';
                        // æ›´æ–°èƒŒæ™¯çŸ©å½¢
                        const bbox = textEl.getBBox();
                        bgRect.setAttribute('x', bbox.x - 5);
                        bgRect.setAttribute('y', bbox.y - 5);
                        bgRect.setAttribute('width', bbox.width + 10);
                        bgRect.setAttribute('height', bbox.height + 10);
                        if (elData.bgFill) bgRect.setAttribute('fill', elData.bgFill);
                        break;
                    case 'book':
                        try {
                            const bookData = JSON.parse(elData.content);
                            element = createBookElementFromData(bookData, elData.x || 50, elData.y || 150);
                        } catch (e) {
                            console.error('è§£æå›¾ä¹¦æ•°æ®å¤±è´¥:', e);
                            // åˆ›å»ºé»˜è®¤å›¾ä¹¦å…ƒç´ 
                            element = createBookElement('', 'å›¾ä¹¦æ ‡é¢˜', 'ä½œè€…', 'å›¾ä¹¦ç®€ä»‹');
                        }
                        break;
                    case 'list-item':
                        // åˆ—è¡¨é¡¹ç‰¹æ®Šå¤„ç†ï¼Œä¼šä½œä¸ºåˆ—è¡¨çš„ä¸€éƒ¨åˆ†
                        element = createTextElement();
                        element.setAttribute('x', elData.x || 50);
                        element.setAttribute('y', elData.y || 130);
                        element.setAttribute('font-size', elData.fontSize || '16');
                        element.textContent = elData.content || 'â€¢ åˆ—è¡¨é¡¹';
                        break;
                }
                
                if (element) {
                    element.addEventListener('click', function(e) {
                        e.stopPropagation();
                        selectElement(element);
                    });
                    
                    svg.appendChild(element);
                    editorState.elements.push({
                        id: elData.id || Date.now() + Math.random(),
                        type: elData.type,
                        element: element,
                        content: elData.content,
                        x: elData.x || 0,
                        y: elData.y || 0
                    });
                }
            });
        }
        
        // ä»æ•°æ®åˆ›å»ºå›¾ä¹¦å…ƒç´ 
        function createBookElementFromData(bookData, x, y) {
            const svg = document.getElementById('editor-svg');
            
            // åˆ›å»ºå›¾ä¹¦ä¿¡æ¯ç»„åˆå…ƒç´ 
            const bookGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            bookGroup.setAttribute('class', 'element');
            bookGroup.setAttribute('data-type', 'book');
            
            // å›¾ä¹¦å°é¢å›¾ç‰‡
            if (bookData.coverUrl) {
                const coverImage = document.createElementNS('http://www.w3.org/2000/svg', 'image');
                coverImage.setAttribute('x', x);
                coverImage.setAttribute('y', y);
                coverImage.setAttribute('width', '80');
                coverImage.setAttribute('height', '100');
                coverImage.setAttribute('href', bookData.coverUrl);
                bookGroup.appendChild(coverImage);
            }
            
            // å›¾ä¹¦æ ‡é¢˜
            const titleText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            titleText.setAttribute('x', bookData.coverUrl ? x + 90 : x);
            titleText.setAttribute('y', bookData.coverUrl ? y + 10 : y);
            titleText.setAttribute('font-family', 'Microsoft YaHei');
            titleText.setAttribute('font-size', '16');
            titleText.setAttribute('font-weight', 'bold');
            titleText.setAttribute('fill', '#000000');
            titleText.setAttribute('contenteditable', 'true');
            titleText.textContent = bookData.title || 'å›¾ä¹¦æ ‡é¢˜';
            bookGroup.appendChild(titleText);
            
            // ä½œè€…ä¿¡æ¯
            if (bookData.author) {
                const authorText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                authorText.setAttribute('x', bookData.coverUrl ? x + 90 : x);
                authorText.setAttribute('y', bookData.coverUrl ? y + 35 : y + 25);
                authorText.setAttribute('font-family', 'Microsoft YaHei');
                authorText.setAttribute('font-size', '14');
                authorText.setAttribute('fill', '#6c757d');
                authorText.setAttribute('contenteditable', 'true');
                authorText.textContent = `ä½œè€…: ${bookData.author}`;
                bookGroup.appendChild(authorText);
            }
            
            // å›¾ä¹¦ç®€ä»‹
            if (bookData.desc) {
                const descText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                descText.setAttribute('x', bookData.coverUrl ? x + 90 : x);
                descText.setAttribute('y', bookData.coverUrl ? y + 60 : y + 50);
                descText.setAttribute('font-family', 'Microsoft YaHei');
                descText.setAttribute('font-size', '14');
                descText.setAttribute('fill', '#495057');
                descText.setAttribute('contenteditable', 'true');
                descText.textContent = bookData.desc;
                bookGroup.appendChild(descText);
            }
            
            // æ·»åŠ ç‚¹å‡»é€‰ä¸­äº‹ä»¶
            bookGroup.addEventListener('click', function(e) {
                e.stopPropagation();
                selectElement(bookGroup);
            });
            
            return bookGroup;
        }
        
        // æ¸…ç©ºç”»å¸ƒï¼ˆä¸ä¿å­˜åˆ°å†å²è®°å½•ï¼‰
        function clearCanvasWithoutHistory() {
            const svg = document.getElementById('editor-svg');
            // ä¿ç•™èƒŒæ™¯rect
            const background = svg.querySelector('rect');
            svg.innerHTML = '';
            if (background) {
                svg.appendChild(background);
            }
            editorState.elements = [];
            editorState.selectedElement = null;
        }
        
        // åŠ è½½æ¨¡æ¿
        function loadTemplate(templateType) {
            let template;
            
            switch(templateType) {
                case 'default':
                    template = getDefaultTemplate();
                    break;
                case 'image':
                    template = getImageTemplate();
                    break;
                case 'book':
                    template = getBookTemplate();
                    break;
                case 'md':
                    template = getMdTemplate();
                    break;
                default:
                    return;
            }
            
            loadTemplateData(template);
            editorState.currentTemplate = templateType;
        }
        
        // è·å–é»˜è®¤æ¨¡æ¿
        function getDefaultTemplate() {
            return {
                name: 'åŸºç¡€æ’ç‰ˆ',
                description: 'ç®€å•çš„æ ‡é¢˜+æ­£æ–‡å¸ƒå±€',
                elements: [
                    {
                        type: 'title',
                        x: 50,
                        y: 80,
                        content: 'æ–‡ç« æ ‡é¢˜',
                        fontSize: '24',
                        fontWeight: 'bold'
                    },
                    {
                        type: 'text',
                        x: 50,
                        y: 150,
                        content: 'è¿™é‡Œæ˜¯æ–‡ç« æ­£æ–‡å†…å®¹ï¼Œæ‚¨å¯ä»¥åœ¨è¿™é‡Œç¼–è¾‘æ–‡æœ¬...',
                        fontSize: '16'
                    }
                ]
            };
        }
        
        // è·å–å›¾ç‰‡æ¨¡æ¿
        function getImageTemplate() {
            return {
                name: 'å›¾ç‰‡æ’ç‰ˆ',
                description: 'å›¾ç‰‡+æ–‡å­—æè¿°å¸ƒå±€',
                elements: [
                    {
                        type: 'title',
                        x: 50,
                        y: 80,
                        content: 'å›¾ç‰‡æ ‡é¢˜',
                        fontSize: '24',
                        fontWeight: 'bold'
                    },
                    {
                        type: 'image',
                        x: 50,
                        y: 150,
                        content: 'https://via.placeholder.com/600x400.png',
                        width: '600',
                        height: '400'
                    },
                    {
                        type: 'text',
                        x: 50,
                        y: 580,
                        content: 'å›¾ç‰‡æè¿°æ–‡å­—',
                        fontSize: '14'
                    }
                ]
            };
        }
        
        // è·å–å›¾ä¹¦æ¨¡æ¿
        function getBookTemplate() {
            return {
                name: 'å›¾ä¹¦ä»‹ç»',
                description: 'å¤šæœ¬ä¹¦ç±ä»‹ç»å¸ƒå±€',
                elements: [
                    {
                        type: 'title',
                        x: 50,
                        y: 80,
                        content: 'æ¨èå¥½ä¹¦',
                        fontSize: '28',
                        fontWeight: 'bold'
                    },
                    {
                        type: 'book',
                        x: 50,
                        y: 150,
                        content: JSON.stringify({
                            coverUrl: 'https://via.placeholder.com/80x100.png',
                            title: 'ã€Šä¹¦ç±åç§°ã€‹',
                            author: 'ä½œè€…å',
                            desc: 'è¿™æ˜¯ä¸€æœ¬éå¸¸æ£’çš„ä¹¦ç±ï¼Œå†…å®¹ä¸°å¯Œï¼Œå€¼å¾—ä¸€è¯»ã€‚'
                        })
                    },
                    {
                        type: 'book',
                        x: 50,
                        y: 300,
                        content: JSON.stringify({
                            coverUrl: 'https://via.placeholder.com/80x100.png',
                            title: 'ã€Šå¦ä¸€æœ¬ä¹¦ã€‹',
                            author: 'å¦ä¸€ä½ä½œè€…',
                            desc: 'è¿™æœ¬ä¹¦ä¹Ÿå¾ˆä¸é”™ï¼Œæ¨èç»™å¤§å®¶ã€‚'
                        })
                    }
                ]
            };
        }
        
        // è·å–MDä¼˜åŒ–æ¨¡æ¿
        function getMdTemplate() {
            return {
                name: 'MDä¼˜åŒ–',
                description: 'Markdownæ ¼å¼ä¼˜åŒ–æ¨¡æ¿',
                elements: [
                    {
                        type: 'title',
                        x: 50,
                        y: 80,
                        content: '# æ ‡é¢˜',
                        fontSize: '24',
                        fontWeight: 'bold'
                    },
                    {
                        type: 'text',
                        x: 50,
                        y: 130,
                        content: 'è¿™æ˜¯ä¸€æ®µ**ç²—ä½“**å’Œ*æ–œä½“*çš„æ–‡æœ¬ã€‚',
                        fontSize: '16'
                    },
                    {
                        type: 'blockquote',
                        x: 40,
                        y: 180,
                        content: 'è¿™æ˜¯ä¸€ä¸ªå¼•ç”¨å—',
                        fontSize: '14'
                    },
                    {
                        type: 'text',
                        x: 50,
                        y: 280,
                        content: '## äºŒçº§æ ‡é¢˜',
                        fontSize: '20',
                        fontWeight: 'bold'
                    },
                    {
                        type: 'text',
                        x: 50,
                        y: 320,
                        content: 'è¿™æ˜¯æ­£æ–‡å†…å®¹ï¼Œæ”¯æŒ`è¡Œå†…ä»£ç `ã€‚',
                        fontSize: '16'
                    }
                ]
            };
        }
        
        // åŠ è½½æ¨¡æ¿æ•°æ®
        function loadTemplateData(template) {
            clearCanvas();
            
            const svg = document.getElementById('editor-svg');
            editorState.elements = [];
            
            template.elements.forEach(el => {
                let element;
                
                switch(el.type) {
                    case 'title':
                        element = createTitleElement();
                        element.setAttribute('x', el.x);
                        element.setAttribute('y', el.y);
                        element.setAttribute('font-size', el.fontSize || '24');
                        if (el.fontWeight) element.setAttribute('font-weight', el.fontWeight);
                        element.textContent = el.content;
                        break;
                    case 'text':
                        element = createTextElement();
                        element.setAttribute('x', el.x);
                        element.setAttribute('y', el.y);
                        element.setAttribute('font-size', el.fontSize || '16');
                        if (el.fontWeight) element.setAttribute('font-weight', el.fontWeight);
                        if (el.fontStyle) element.setAttribute('font-style', el.fontStyle);
                        if (el.fill) element.setAttribute('fill', el.fill);
                        if (el.textAnchor) element.setAttribute('text-anchor', el.textAnchor);
                        element.textContent = el.content;
                        break;
                    case 'image':
                        element = createImageElement();
                        element.setAttribute('x', el.x);
                        element.setAttribute('y', el.y);
                        element.setAttribute('width', el.width || '300');
                        element.setAttribute('height', el.height || '200');
                        element.setAttribute('href', el.content);
                        break;
                    case 'divider':
                        element = createDividerElement();
                        element.setAttribute('x1', el.x1 || 50);
                        element.setAttribute('y1', el.y1 || 200);
                        element.setAttribute('x2', el.x2 || 700);
                        element.setAttribute('y2', el.y2 || 200);
                        break;
                    case 'blockquote':
                        element = createQuoteElement();
                        const rect = element.querySelector('rect');
                        const text = element.querySelector('text');
                        rect.setAttribute('x', el.x || 40);
                        rect.setAttribute('y', (el.y - 30) || 220);
                        rect.setAttribute('width', '500');
                        rect.setAttribute('height', '100');
                        text.setAttribute('x', (el.x + 20) || 60);
                        text.setAttribute('y', el.y || 250);
                        text.setAttribute('font-size', el.fontSize || '14');
                        text.textContent = el.content;
                        break;
                    case 'highlight':
                        element = createHighlightElement();
                        const g = element;
                        const bgRect = g.querySelector('rect');
                        const textEl = g.querySelector('text');
                        textEl.setAttribute('x', el.x || 50);
                        textEl.setAttribute('y', el.y || 130);
                        textEl.setAttribute('font-size', el.fontSize || '16');
                        if (el.fontWeight) textEl.setAttribute('font-weight', el.fontWeight);
                        if (el.fontStyle) textEl.setAttribute('font-style', el.fontStyle);
                        if (el.fill) textEl.setAttribute('fill', el.fill);
                        textEl.textContent = el.content;
                        // æ›´æ–°èƒŒæ™¯çŸ©å½¢
                        const bbox = textEl.getBBox();
                        bgRect.setAttribute('x', bbox.x - 5);
                        bgRect.setAttribute('y', bbox.y - 5);
                        bgRect.setAttribute('width', bbox.width + 10);
                        bgRect.setAttribute('height', bbox.height + 10);
                        if (el.bgFill) bgRect.setAttribute('fill', el.bgFill);
                        break;
                    case 'book':
                        try {
                            const bookData = JSON.parse(el.content);
                            element = createBookElementFromData(bookData, el.x, el.y);
                        } catch (e) {
                            console.error('è§£æå›¾ä¹¦æ•°æ®å¤±è´¥:', e);
                            // åˆ›å»ºé»˜è®¤å›¾ä¹¦å…ƒç´ 
                            element = createBookElement('', 'å›¾ä¹¦æ ‡é¢˜', 'ä½œè€…', 'å›¾ä¹¦ç®€ä»‹');
                        }
                        break;
                }
                
                if (element) {
                    element.addEventListener('click', function(e) {
                        e.stopPropagation();
                        selectElement(element);
                    });
                    
                    svg.appendChild(element);
                    editorState.elements.push({
                        id: Date.now() + Math.random(),
                        type: el.type,
                        element: element,
                        content: el.content,
                        x: el.x || 0,
                        y: el.y || 0
                    });
                }
            });
            
            saveStateToHistory();
        }
        
        // æ˜¾ç¤ºä¿å­˜æ¨¡æ¿æ¨¡æ€æ¡†
        function showSaveTemplateModal() {
            document.getElementById('save-template-modal').style.display = 'block';
        }
        
        // éšè—ä¿å­˜æ¨¡æ¿æ¨¡æ€æ¡†
        function hideSaveTemplateModal() {
            document.getElementById('save-template-modal').style.display = 'none';
            document.getElementById('template-name').value = '';
            document.getElementById('template-desc').value = '';
            document.getElementById('template-tags').value = '';
        }
        
        // åŠ è½½å·²ä¿å­˜çš„æ¨¡æ¿åˆ°ä¾§è¾¹æ 
        function loadSavedTemplatesToSidebar() {
            const container = document.getElementById('saved-templates-container');
            container.innerHTML = '';
            
            const savedTemplates = JSON.parse(localStorage.getItem('wechatTemplates') || '[]');
            
            if (savedTemplates.length === 0) {
                container.innerHTML = '<p style="color: #999; font-size: 14px; padding: 10px 0;">æš‚æ— ä¿å­˜çš„æ¨¡æ¿</p>';
                return;
            }
            
            savedTemplates.slice(0, 5).forEach((template, index) => {
                const templateDiv = document.createElement('div');
                templateDiv.className = 'saved-template-item';
                templateDiv.innerHTML = `
                    <h5>${template.name}</h5>
                    <p>${template.description || 'æ— æè¿°'}</p>
                    <div class="actions">
                        <button class="btn-load" onclick="loadSavedTemplate(${index})">åŠ è½½</button>
                        <button class="btn-edit" onclick="editSavedTemplate(${index})">ç¼–è¾‘</button>
                        <button class="btn-delete" onclick="deleteSavedTemplate(${index})">åˆ é™¤</button>
                    </div>
                `;
                container.appendChild(templateDiv);
            });
            
            if (savedTemplates.length > 5) {
                const moreDiv = document.createElement('div');
                moreDiv.innerHTML = `<button style="width:100%; padding:8px; margin-top:10px;" onclick="document.getElementById('template-manager-modal').style.display='block';loadAllTemplatesToManager();">æŸ¥çœ‹å…¨éƒ¨ ${savedTemplates.length} ä¸ªæ¨¡æ¿</button>`;
                container.appendChild(moreDiv);
            }
        }
        
        // åŠ è½½æ‰€æœ‰æ¨¡æ¿åˆ°ç®¡ç†å™¨
        function loadAllTemplatesToManager() {
            const container = document.getElementById('all-templates-list');
            container.innerHTML = '';
            
            const savedTemplates = JSON.parse(localStorage.getItem('wechatTemplates') || '[]');
            
            if (savedTemplates.length === 0) {
                container.innerHTML = '<p>æš‚æ— ä¿å­˜çš„æ¨¡æ¿</p>';
                return;
            }
            
            savedTemplates.forEach((template, index) => {
                const templateDiv = document.createElement('div');
                templateDiv.className = 'saved-template-item';
                templateDiv.innerHTML = `
                    <h5>${template.name}</h5>
                    <p>${template.description || 'æ— æè¿°'}</p>
                    <p><small>æ ‡ç­¾: ${template.tags || 'æ— '}</small></p>
                    <div class="actions">
                        <button class="btn-load" onclick="loadSavedTemplateFromManager(${index})">åŠ è½½</button>
                        <button class="btn-edit" onclick="editSavedTemplate(${index})">ç¼–è¾‘</button>
                        <button class="btn-delete" onclick="deleteSavedTemplate(${index})">åˆ é™¤</button>
                    </div>
                `;
                container.appendChild(templateDiv);
            });
        }
        
        // ä»ç®¡ç†å™¨åŠ è½½æ¨¡æ¿
        function loadSavedTemplateFromManager(index) {
            loadSavedTemplate(index);
            document.getElementById('template-manager-modal').style.display = 'none';
        }
        
        // åŠ è½½å·²ä¿å­˜çš„æ¨¡æ¿
        function loadSavedTemplate(index) {
            const savedTemplates = JSON.parse(localStorage.getItem('wechatTemplates') || '[]');
            if (index >= 0 && index < savedTemplates.length) {
                loadTemplateData(savedTemplates[index]);
                editorState.currentTemplate = `saved-${index}`;
            }
        }
        
        // ç¼–è¾‘å·²ä¿å­˜çš„æ¨¡æ¿
        function editSavedTemplate(index) {
            const savedTemplates = JSON.parse(localStorage.getItem('wechatTemplates') || '[]');
            if (index >= 0 && index < savedTemplates.length) {
                const template = savedTemplates[index];
                document.getElementById('template-name').value = template.name;
                document.getElementById('template-desc').value = template.description || '';
                document.getElementById('template-tags').value = template.tags || '';
                
                // æ˜¾ç¤ºæ¨¡æ€æ¡†å¹¶è®¾ç½®ä¸ºç¼–è¾‘æ¨¡å¼
                document.getElementById('save-template-modal').style.display = 'block';
                
                // ä¸´æ—¶å­˜å‚¨æ­£åœ¨ç¼–è¾‘çš„æ¨¡æ¿ç´¢å¼•
                document.getElementById('confirm-save').setAttribute('data-edit-index', index);
                document.getElementById('confirm-save').textContent = 'æ›´æ–°æ¨¡æ¿';
            }
        }
        
        // åˆ é™¤æ¨¡æ¿
        function deleteSavedTemplate(index) {
            const savedTemplates = JSON.parse(localStorage.getItem('wechatTemplates') || '[]');
            if (index >= 0 && index < savedTemplates.length) {
                if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ¨¡æ¿å—ï¼Ÿ')) {
                    savedTemplates.splice(index, 1);
                    localStorage.setItem('wechatTemplates', JSON.stringify(savedTemplates));
                    loadSavedTemplatesToSidebar();
                    loadAllTemplatesToManager();
                }
            }
        }
        
        // ä¿å­˜æ¨¡æ¿
        function saveTemplate() {
            const name = document.getElementById('template-name').value.trim();
            if (!name) {
                alert('è¯·è¾“å…¥æ¨¡æ¿åç§°');
                return;
            }
            
            const desc = document.getElementById('template-desc').value.trim();
            const tags = document.getElementById('template-tags').value.trim();
            
            // è·å–å½“å‰ç¼–è¾‘å™¨å†…å®¹
            const template = {
                name: name,
                description: desc,
                tags: tags,
                elements: editorState.elements.map(el => {
                    const element = el.element;
                    const attrs = {
                        type: el.type,
                        content: el.content,
                        id: el.id,
                        x: el.x,
                        y: el.y
                    };
                    
                    // è·å–ä½ç½®å’Œæ ·å¼å±æ€§
                    if (element.tagName === 'text' || element.tagName === 'title') {
                        attrs.x = parseInt(element.getAttribute('x')) || 0;
                        attrs.y = parseInt(element.getAttribute('y')) || 0;
                        attrs.fontSize = element.getAttribute('font-size') || '16';
                        attrs.fontWeight = element.getAttribute('font-weight');
                        attrs.fontStyle = element.getAttribute('font-style');
                        attrs.fill = element.getAttribute('fill');
                        attrs.textAnchor = element.getAttribute('text-anchor');
                    } else if (element.tagName === 'g' && element.querySelector('rect') && element.querySelector('text')) {
                        // é«˜äº®æ–‡æœ¬çš„å¤„ç†
                        const textEl = element.querySelector('text');
                        attrs.x = parseInt(textEl.getAttribute('x')) || 0;
                        attrs.y = parseInt(textEl.getAttribute('y')) || 0;
                        attrs.fontSize = textEl.getAttribute('font-size') || '16';
                        attrs.fontWeight = textEl.getAttribute('font-weight');
                        attrs.fontStyle = textEl.getAttribute('font-style');
                        attrs.fill = textEl.getAttribute('fill');
                        const bgRect = element.querySelector('rect');
                        attrs.bgFill = bgRect.getAttribute('fill');
                    } else if (element.tagName === 'g' && element.getAttribute('data-type') === 'book') {
                        // å›¾ä¹¦å…ƒç´ çš„å¤„ç†
                        const coverImage = element.querySelector('image');
                        const titleText = element.querySelector('text');
                        const authorText = element.querySelectorAll('text')[1];
                        const descText = element.querySelectorAll('text')[2];
                        
                        const bookData = {
                            coverUrl: coverImage ? coverImage.getAttribute('href') : '',
                            title: titleText ? titleText.textContent : '',
                            author: authorText ? authorText.textContent.replace('ä½œè€…: ', '') : '',
                            desc: descText ? descText.textContent : ''
                        };
                        
                        attrs.content = JSON.stringify(bookData);
                        attrs.x = parseInt(element.getAttribute('x')) || 0;
                        attrs.y = parseInt(element.getAttribute('y')) || 0;
                    } else if (element.tagName === 'image') {
                        attrs.x = parseInt(element.getAttribute('x')) || 0;
                        attrs.y = parseInt(element.getAttribute('y')) || 0;
                        attrs.width = element.getAttribute('width') || '300';
                        attrs.height = element.getAttribute('height') || '200';
                        attrs.href = element.getAttribute('href');
                    } else if (element.tagName === 'line') {
                        attrs.x1 = parseInt(element.getAttribute('x1')) || 0;
                        attrs.y1 = parseInt(element.getAttribute('y1')) || 0;
                        attrs.x2 = parseInt(element.getAttribute('x2')) || 0;
                        attrs.y2 = parseInt(element.getAttribute('y2')) || 0;
                    } else if (element.tagName === 'g') {
                        // å¼•ç”¨å—çš„å¤„ç†
                        const textEl = element.querySelector('text');
                        if (textEl) {
                            attrs.x = parseInt(textEl.getAttribute('x')) || 0;
                            attrs.y = parseInt(textEl.getAttribute('y')) || 0;
                            attrs.fontSize = textEl.getAttribute('font-size') || '14';
                        }
                    }
                    
                    return attrs;
                })
            };
            
            // æ£€æŸ¥æ˜¯å¦æ­£åœ¨ç¼–è¾‘ç°æœ‰æ¨¡æ¿
            const editIndex = document.getElementById('confirm-save').getAttribute('data-edit-index');
            if (editIndex !== null) {
                // æ›´æ–°ç°æœ‰æ¨¡æ¿
                const savedTemplates = JSON.parse(localStorage.getItem('wechatTemplates') || '[]');
                if (editIndex >= 0 && editIndex < savedTemplates.length) {
                    savedTemplates[editIndex] = template;
                    localStorage.setItem('wechatTemplates', JSON.stringify(savedTemplates));
                    alert('æ¨¡æ¿æ›´æ–°æˆåŠŸï¼');
                }
                // é‡ç½®æŒ‰é’®çŠ¶æ€
                document.getElementById('confirm-save').removeAttribute('data-edit-index');
                document.getElementById('confirm-save').textContent = 'ä¿å­˜æ¨¡æ¿';
            } else {
                // æ·»åŠ æ–°æ¨¡æ¿
                const savedTemplates = JSON.parse(localStorage.getItem('wechatTemplates') || '[]');
                savedTemplates.push(template);
                localStorage.setItem('wechatTemplates', JSON.stringify(savedTemplates));
                alert('æ¨¡æ¿ä¿å­˜æˆåŠŸï¼');
            }
            
            hideSaveTemplateModal();
            loadSavedTemplatesToSidebar();
            loadAllTemplatesToManager();
        }
        
        // å¯¼å…¥æ¨¡æ¿
        function importTemplate() {
            document.getElementById('template-file').click();
        }
        
        // å¤„ç†æ¨¡æ¿æ–‡ä»¶
        function handleTemplateFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const template = JSON.parse(e.target.result);
                    
                    if (!template.name || !template.elements) {
                        alert('æ¨¡æ¿æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®');
                        return;
                    }
                    
                    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                    const savedTemplates = JSON.parse(localStorage.getItem('wechatTemplates') || '[]');
                    savedTemplates.push(template);
                    localStorage.setItem('wechatTemplates', JSON.stringify(savedTemplates));
                    
                    alert('æ¨¡æ¿å¯¼å…¥æˆåŠŸï¼');
                    loadSavedTemplatesToSidebar();
                    loadAllTemplatesToManager();
                } catch (error) {
                    alert('æ¨¡æ¿æ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼');
                }
            };
            reader.readAsText(file);
        }
        
        // å¯¼å‡ºæ¨¡æ¿
        function exportTemplate() {
            if (editorState.elements.length === 0) {
                alert('å½“å‰ç”»å¸ƒä¸ºç©ºï¼Œæ— æ³•å¯¼å‡ºæ¨¡æ¿');
                return;
            }
            
            const template = {
                name: `å¯¼å‡ºæ¨¡æ¿_${new Date().toLocaleDateString()}`,
                description: 'ä»å½“å‰ç”»å¸ƒå¯¼å‡ºçš„æ¨¡æ¿',
                elements: editorState.elements.map(el => {
                    const element = el.element;
                    const attrs = {
                        type: el.type,
                        content: el.content,
                        id: el.id,
                        x: el.x,
                        y: el.y
                    };
                    
                    // è·å–ä½ç½®å’Œæ ·å¼å±æ€§
                    if (element.tagName === 'text' || element.tagName === 'title') {
                        attrs.x = parseInt(element.getAttribute('x')) || 0;
                        attrs.y = parseInt(element.getAttribute('y')) || 0;
                        attrs.fontSize = element.getAttribute('font-size') || '16';
                        attrs.fontWeight = element.getAttribute('font-weight');
                        attrs.fontStyle = element.getAttribute('font-style');
                        attrs.fill = element.getAttribute('fill');
                        attrs.textAnchor = element.getAttribute('text-anchor');
                    } else if (element.tagName === 'g' && element.querySelector('rect') && element.querySelector('text')) {
                        // é«˜äº®æ–‡æœ¬çš„å¤„ç†
                        const textEl = element.querySelector('text');
                        attrs.x = parseInt(textEl.getAttribute('x')) || 0;
                        attrs.y = parseInt(textEl.getAttribute('y')) || 0;
                        attrs.fontSize = textEl.getAttribute('font-size') || '16';
                        attrs.fontWeight = textEl.getAttribute('font-weight');
                        attrs.fontStyle = textEl.getAttribute('font-style');
                        attrs.fill = textEl.getAttribute('fill');
                        const bgRect = element.querySelector('rect');
                        attrs.bgFill = bgRect.getAttribute('fill');
                    } else if (element.tagName === 'g' && element.getAttribute('data-type') === 'book') {
                        // å›¾ä¹¦å…ƒç´ çš„å¤„ç†
                        const coverImage = element.querySelector('image');
                        const titleText = element.querySelector('text');
                        const authorText = element.querySelectorAll('text')[1];
                        const descText = element.querySelectorAll('text')[2];
                        
                        const bookData = {
                            coverUrl: coverImage ? coverImage.getAttribute('href') : '',
                            title: titleText ? titleText.textContent : '',
                            author: authorText ? authorText.textContent.replace('ä½œè€…: ', '') : '',
                            desc: descText ? descText.textContent : ''
                        };
                        
                        attrs.content = JSON.stringify(bookData);
                        attrs.x = parseInt(element.getAttribute('x')) || 0;
                        attrs.y = parseInt(element.getAttribute('y')) || 0;
                    } else if (element.tagName === 'image') {
                        attrs.x = parseInt(element.getAttribute('x')) || 0;
                        attrs.y = parseInt(element.getAttribute('y')) || 0;
                        attrs.width = element.getAttribute('width') || '300';
                        attrs.height = element.getAttribute('height') || '200';
                        attrs.href = element.getAttribute('href');
                    } else if (element.tagName === 'line') {
                        attrs.x1 = parseInt(element.getAttribute('x1')) || 0;
                        attrs.y1 = parseInt(element.getAttribute('y1')) || 0;
                        attrs.x2 = parseInt(element.getAttribute('x2')) || 0;
                        attrs.y2 = parseInt(element.getAttribute('y2')) || 0;
                    } else if (element.tagName === 'g') {
                        // å¼•ç”¨å—çš„å¤„ç†
                        const textEl = element.querySelector('text');
                        if (textEl) {
                            attrs.x = parseInt(textEl.getAttribute('x')) || 0;
                            attrs.y = parseInt(textEl.getAttribute('y')) || 0;
                            attrs.fontSize = textEl.getAttribute('font-size') || '14';
                        }
                    }
                    
                    return attrs;
                })
            };
            
            const dataStr = JSON.stringify(template, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `template_${new Date().getTime()}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }
        
        // æ¸…ç©ºç”»å¸ƒ
        function clearCanvas() {
            const svg = document.getElementById('editor-svg');
            // ä¿ç•™èƒŒæ™¯rect
            const background = svg.querySelector('rect');
            svg.innerHTML = '';
            if (background) {
                svg.appendChild(background);
            }
            editorState.elements = [];
            editorState.selectedElement = null;
            saveStateToHistory();
        }
        
        // åˆ é™¤é€‰ä¸­å…ƒç´ 
        function deleteSelectedElement() {
            if (!editorState.selectedElement) return;
            
            // ä»DOMä¸­ç§»é™¤å…ƒç´ 
            editorState.selectedElement.remove();
            
            // ä»çŠ¶æ€ä¸­ç§»é™¤å…ƒç´ 
            editorState.elements = editorState.elements.filter(el => el.element !== editorState.selectedElement);
            
            editorState.selectedElement = null;
            saveStateToHistory();
        }
        
        // å¤åˆ¶å…ƒç´ 
        function copyElement() {
            if (!editorState.selectedElement) return;
            
            const elementObj = editorState.elements.find(el => el.element === editorState.selectedElement);
            if (elementObj) {
                editorState.clipboard = {...elementObj};
                // ä¸å¤åˆ¶DOMå…ƒç´ å¼•ç”¨
                editorState.clipboard.element = null;
                alert('å·²å¤åˆ¶é€‰ä¸­å…ƒç´ ');
            }
        }
        
        // ç²˜è´´å…ƒç´ 
        function pasteElement() {
            if (!editorState.clipboard) return;
            
            const svg = document.getElementById('editor-svg');
            let element;
            const clipboard = editorState.clipboard;
            
            switch(clipboard.type) {
                case 'title':
                    element = createTitleElement();
                    element.setAttribute('x', (parseInt(clipboard.x) + 20).toString());
                    element.setAttribute('y', (parseInt(clipboard.y) + 20).toString());
                    element.setAttribute('font-size', clipboard.fontSize || '24');
                    if (clipboard.fontWeight) element.setAttribute('font-weight', clipboard.fontWeight);
                    element.textContent = clipboard.content || 'æ ‡é¢˜';
                    break;
                case 'text':
                    element = createTextElement();
                    element.setAttribute('x', (parseInt(clipboard.x) + 20).toString());
                    element.setAttribute('y', (parseInt(clipboard.y) + 20).toString());
                    element.setAttribute('font-size', clipboard.fontSize || '16');
                    if (clipboard.fontWeight) element.setAttribute('font-weight', clipboard.fontWeight);
                    if (clipboard.fontStyle) element.setAttribute('font-style', clipboard.fontStyle);
                    if (clipboard.fill) element.setAttribute('fill', clipboard.fill);
                    if (clipboard.textAnchor) element.setAttribute('text-anchor', clipboard.textAnchor);
                    element.textContent = clipboard.content || 'ç‚¹å‡»ç¼–è¾‘æ–‡æœ¬';
                    break;
                case 'highlight':
                    element = createHighlightElement();
                    const g = element;
                    const bgRect = g.querySelector('rect');
                    const textEl = g.querySelector('text');
                    textEl.setAttribute('x', (parseInt(clipboard.x) + 20).toString());
                    textEl.setAttribute('y', (parseInt(clipboard.y) + 20).toString());
                    textEl.setAttribute('font-size', clipboard.fontSize || '16');
                    if (clipboard.fontWeight) textEl.setAttribute('font-weight', clipboard.fontWeight);
                    if (clipboard.fontStyle) textEl.setAttribute('font-style', clipboard.fontStyle);
                    if (clipboard.fill) textEl.setAttribute('fill', clipboard.fill);
                    textEl.textContent = clipboard.content || 'é«˜äº®æ–‡æœ¬';
                    // æ›´æ–°èƒŒæ™¯çŸ©å½¢
                    const bbox = textEl.getBBox();
                    bgRect.setAttribute('x', bbox.x - 5);
                    bgRect.setAttribute('y', bbox.y - 5);
                    bgRect.setAttribute('width', bbox.width + 10);
                    bgRect.setAttribute('height', bbox.height + 10);
                    if (clipboard.bgFill) bgRect.setAttribute('fill', clipboard.bgFill);
                    break;
                case 'image':
                    element = createImageElement();
                    element.setAttribute('x', (parseInt(clipboard.x) + 20).toString());
                    element.setAttribute('y', (parseInt(clipboard.y) + 20).toString());
                    element.setAttribute('width', clipboard.width || '300');
                    element.setAttribute('height', clipboard.height || '200');
                    element.setAttribute('href', clipboard.content || 'https://via.placeholder.com/300x200.png');
                    break;
                case 'divider':
                    element = createDividerElement();
                    element.setAttribute('x1', (parseInt(clipboard.x1) + 20).toString() || '70');
                    element.setAttribute('y1', (parseInt(clipboard.y1) + 20).toString() || '220');
                    element.setAttribute('x2', (parseInt(clipboard.x2) + 20).toString() || '720');
                    element.setAttribute('y2', (parseInt(clipboard.y2) + 20).toString() || '220');
                    break;
                case 'blockquote':
                    element = createQuoteElement();
                    const rect = element.querySelector('rect');
                    const text = element.querySelector('text');
                    const x = parseInt(clipboard.x) + 20 || 60;
                    const y = parseInt(clipboard.y) + 20 || 270;
                    rect.setAttribute('x', x - 20);
                    rect.setAttribute('y', y - 50);
                    rect.setAttribute('width', '500');
                    rect.setAttribute('height', '100');
                    text.setAttribute('x', x);
                    text.setAttribute('y', y);
                    text.setAttribute('font-size', clipboard.fontSize || '14');
                    text.textContent = clipboard.content || 'è¿™æ˜¯å¼•ç”¨å—å†…å®¹ï¼Œç”¨äºçªå‡ºæ˜¾ç¤ºé‡è¦è§‚ç‚¹æˆ–å¼•ç”¨ä»–äººçš„è¯è¯­ã€‚';
                    break;
                case 'book':
                    try {
                        const bookData = JSON.parse(clipboard.content);
                        element = createBookElementFromData(bookData, (parseInt(clipboard.x) + 20), (parseInt(clipboard.y) + 20));
                    } catch (e) {
                        console.error('è§£æå›¾ä¹¦æ•°æ®å¤±è´¥:', e);
                        // åˆ›å»ºé»˜è®¤å›¾ä¹¦å…ƒç´ 
                        element = createBookElement('', 'å›¾ä¹¦æ ‡é¢˜', 'ä½œè€…', 'å›¾ä¹¦ç®€ä»‹');
                    }
                    break;
                case 'list-item':
                    element = createTextElement();
                    element.setAttribute('x', (parseInt(clipboard.x) + 20).toString());
                    element.setAttribute('y', (parseInt(clipboard.y) + 20).toString());
                    element.setAttribute('font-size', clipboard.fontSize || '16');
                    element.textContent = clipboard.content || 'â€¢ åˆ—è¡¨é¡¹';
                    break;
            }
            
            if (element) {
                element.addEventListener('click', function(e) {
                    e.stopPropagation();
                    selectElement(element);
                });
                
                svg.appendChild(element);
                editorState.elements.push({
                    id: Date.now() + Math.random(),
                    type: clipboard.type,
                    element: element,
                    content: clipboard.content,
                    x: parseInt(element.getAttribute('x')),
                    y: parseInt(element.getAttribute('y'))
                });
                
                selectElement(element);
                saveStateToHistory();
            }
        }
        
        // å¯¹é½æ–‡æœ¬
        function alignText(alignment) {
            if (!editorState.selectedElement) return;
            const element = editorState.selectedElement;
            if (element.tagName === 'text' || element.tagName === 'title') {
                let anchor;
                switch(alignment) {
                    case 'start':
                        anchor = 'start';
                        break;
                    case 'middle':
                        anchor = 'middle';
                        break;
                    case 'end':
                        anchor = 'end';
                        break;
                    case 'justify':
                        // SVGä¸æ”¯æŒä¸¤ç«¯å¯¹é½ï¼Œä½¿ç”¨text-anchor middleä½œä¸ºè¿‘ä¼¼
                        anchor = 'middle';
                        break;
                    default:
                        anchor = 'start';
                }
                element.setAttribute('text-anchor', anchor);
                updateElementData(element);
                saveStateToHistory();
            }
        }
        
        // æ’å…¥é“¾æ¥
        function insertLink() {
            if (!editorState.selectedElement) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ–‡æœ¬å…ƒç´ ');
                return;
            }
            
            const url = prompt('è¯·è¾“å…¥é“¾æ¥åœ°å€:');
            if (url) {
                // è¿™é‡Œå¯ä»¥æ‰©å±•åŠŸèƒ½ï¼Œå°†æ–‡æœ¬åŒ…è£…æˆé“¾æ¥
                alert('é“¾æ¥åŠŸèƒ½å°†åœ¨åç»­ç‰ˆæœ¬ä¸­å®ç°');
            }
        }
        
        // æ’å…¥è¡¨æƒ…
        function insertEmoji() {
            if (!editorState.selectedElement) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ–‡æœ¬å…ƒç´ ');
                return;
            }
            
            const emojis = ['ğŸ˜€', 'ğŸ˜‚', 'ğŸ˜', 'ğŸ˜', 'ğŸ‘', 'â¤ï¸', 'ğŸ”¥', 'âœ¨', 'ğŸ‰', 'ğŸ’¡'];
            const selectedEmoji = prompt(`è¯·é€‰æ‹©æˆ–è¾“å…¥è¡¨æƒ…:\n${emojis.join(' ')}`);
            if (selectedEmoji) {
                if (editorState.selectedElement.tagName === 'text' || 
                    editorState.selectedElement.tagName === 'title') {
                    editorState.selectedElement.textContent += selectedEmoji;
                    updateElementData(editorState.selectedElement);
                    saveStateToHistory();
                }
            }
        }
        
        // åˆ‡æ¢ç²—ä½“
        function toggleBold() {
            if (!editorState.selectedElement) return;
            const element = editorState.selectedElement;
            if (element.tagName === 'text' || element.tagName === 'title') {
                const currentWeight = element.getAttribute('font-weight') || 'normal';
                const newWeight = currentWeight === 'bold' ? 'normal' : 'bold';
                element.setAttribute('font-weight', newWeight);
                updateElementData(element);
                saveStateToHistory();
            }
        }
        
        // åˆ‡æ¢æ–œä½“
        function toggleItalic() {
            if (!editorState.selectedElement) return;
            const element = editorState.selectedElement;
            if (element.tagName === 'text' || element.tagName === 'title') {
                const currentStyle = element.getAttribute('font-style') || 'normal';
                const newStyle = currentStyle === 'italic' ? 'normal' : 'italic';
                element.setAttribute('font-style', newStyle);
                updateElementData(element);
                saveStateToHistory();
            }
        }
        
        // åˆ‡æ¢ä¸‹åˆ’çº¿
        function toggleUnderline() {
            if (!editorState.selectedElement) return;
            const element = editorState.selectedElement;
            if (element.tagName === 'text' || element.tagName === 'title') {
                const currentTextDecoration = element.getAttribute('text-decoration') || 'none';
                const newDecoration = currentTextDecoration === 'underline' ? 'none' : 'underline';
                element.setAttribute('text-decoration', newDecoration);
                updateElementData(element);
                saveStateToHistory();
            }
        }
        
        // åˆ‡æ¢åˆ é™¤çº¿
        function toggleStrikethrough() {
            if (!editorState.selectedElement) return;
            const element = editorState.selectedElement;
            if (element.tagName === 'text' || element.tagName === 'title') {
                const currentTextDecoration = element.getAttribute('text-decoration') || 'none';
                let newDecoration;
                if (currentTextDecoration === 'line-through') {
                    newDecoration = currentTextDecoration.replace('line-through', '').trim() || 'none';
                } else {
                    newDecoration = currentTextDecoration === 'none' ? 'line-through' : currentTextDecoration + ' line-through';
                }
                element.setAttribute('text-decoration', newDecoration);
                updateElementData(element);
                saveStateToHistory();
            }
        }
        
        // æ”¹å˜æ–‡å­—é¢œè‰²
        function changeTextColor() {
            if (!editorState.selectedElement) return;
            const element = editorState.selectedElement;
            const color = document.getElementById('text-color').value;
            if (['text', 'image', 'rect'].includes(element.tagName)) {
                element.setAttribute('fill', color);
                updateElementData(element);
                saveStateToHistory();
            }
        }
        
        // æ”¹å˜èƒŒæ™¯é¢œè‰²
        function changeBgColor() {
            const svg = document.getElementById('editor-svg');
            const background = svg.querySelector('rect');
            if (background) {
                background.setAttribute('fill', document.getElementById('bg-color').value);
                saveStateToHistory();
            }
        }
        
        // æ”¹å˜å­—ä½“
        function changeFontFamily() {
            if (!editorState.selectedElement) return;
            const element = editorState.selectedElement;
            if (element.tagName === 'text' || element.tagName === 'title') {
                element.setAttribute('font-family', document.getElementById('font-family').value);
                updateElementData(element);
                saveStateToHistory();
            }
        }
        
        // æ”¹å˜å­—ä½“å¤§å°
        function changeFontSize() {
            if (!editorState.selectedElement) return;
            const element = editorState.selectedElement;
            if (element.tagName === 'text' || element.tagName === 'title') {
                element.setAttribute('font-size', document.getElementById('font-size').value);
                updateElementData(element);
                saveStateToHistory();
            }
        }
        
        // å°†ç”»å¸ƒå†…å®¹è½¬æ¢ä¸ºå¾®ä¿¡å…¬ä¼—å·æ ¼å¼
        function convertCanvasToWeChatFormat() {
            // è¿™é‡Œéœ€è¦å®ç°å°†SVGå…ƒç´ è½¬æ¢ä¸ºHTMLæ ¼å¼çš„é€»è¾‘
            // ä»¥ä¾¿ä¸å¾®ä¿¡å…¬ä¼—å·ç¼–è¾‘å™¨å…¼å®¹
            let htmlContent = '<div style="max-width: 100%; font-family: -apple-system, BlinkMacSystemFont, \'Segoe UI\', \'PingFang SC\', \'Hiragino Sans GB\', \'Microsoft YaHei\', sans-serif; line-height: 1.6;">';
            
            // æŒ‰Yåæ ‡æ’åºå…ƒç´ ï¼Œç¡®ä¿æ­£ç¡®çš„æ˜¾ç¤ºé¡ºåº
            const sortedElements = [...editorState.elements].sort((a, b) => a.y - b.y);
            
            sortedElements.forEach(el => {
                switch(el.type) {
                    case 'title':
                        htmlContent += `<h1 style="font-size: ${el.fontSize}px; font-weight: bold; margin: 20px 0 10px; color: #333;">${el.content}</h1>`;
                        break;
                    case 'text':
                        // è§£ææ–‡æœ¬ä¸­çš„Markdownæ ·å¼
                        let textContent = el.content;
                        textContent = textContent.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                        textContent = textContent.replace(/\*(.*?)\*/g, '<em>$1</em>');
                        textContent = textContent.replace(/__(.*?)__/g, '<strong>$1</strong>');
                        textContent = textContent.replace(/_(.*?)_/g, '<em>$1</em>');
                        
                        htmlContent += `<p style="font-size: ${el.fontSize}px; margin: 10px 0; line-height: 1.6;">${textContent}</p>`;
                        break;
                    case 'highlight':
                        htmlContent += `<p style="font-size: ${el.fontSize}px; margin: 10px 0; line-height: 1.6;"><span style="background-color: #ff6b6b; color: white; padding: 2px 6px; border-radius: 3px;">${el.content}</span></p>`;
                        break;
                    case 'image':
                        htmlContent += `<div style="margin: 20px 0; text-align: center;"><img src="${el.content}" style="width: 100%; max-width: 600px; height: auto; border-radius: 4px;" alt="å›¾ç‰‡"></div>`;
                        break;
                    case 'divider':
                        htmlContent += `<div style="margin: 20px 0; height: 1px; background-color: #eee;"></div>`;
                        break;
                    case 'blockquote':
                        htmlContent += `<blockquote style="margin: 20px 0; padding: 15px 20px; background: #f8f9fa; border-left: 4px solid #007bff; color: #6c757d; font-style: italic; border-radius: 0 4px 4px 0;">${el.content}</blockquote>`;
                        break;
                    case 'book':
                        try {
                            const bookData = JSON.parse(el.content);
                            htmlContent += `
                            <div class="book-item" style="display: flex; margin: 15px 0; padding: 10px; border: 1px solid #eee; border-radius: 6px; background-color: #fafafa;">
                                ${bookData.coverUrl ? `<div class="book-cover" style="width: 80px; height: 100px; background-color: #e9ecef; border-radius: 4px; margin-right: 15px; display: flex; align-items: center; justify-content: center; color: #6c757d; font-size: 12px; text-align: center; background-image: url(${bookData.coverUrl}); background-size: cover; background-position: center;"></div>` : ''}
                                <div class="book-info" style="flex: 1;">
                                    <div class="book-title" style="font-weight: bold; margin-bottom: 5px;">${bookData.title}</div>
                                    <div class="book-author" style="color: #6c757d; font-size: 14px; margin-bottom: 5px;">ä½œè€…: ${bookData.author}</div>
                                    <div class="book-desc" style="font-size: 13px; color: #495057;">${bookData.desc}</div>
                                </div>
                            </div>`;
                        } catch (e) {
                            console.error('è§£æå›¾ä¹¦æ•°æ®å¤±è´¥:', e);
                        }
                        break;
                    case 'list-item':
                        htmlContent += `<p style="font-size: ${el.fontSize}px; margin: 8px 0; text-indent: 0;">${el.content}</p>`;
                        break;
                }
            });
            
            htmlContent += '</div>';
            return htmlContent;
        }
        
        // ä¾›HTMLè°ƒç”¨çš„å…¨å±€å‡½æ•°
        window.loadSavedTemplate = loadSavedTemplate;
        window.deleteSavedTemplate = deleteSavedTemplate;
        window.editSavedTemplate = editSavedTemplate;
    </script>
</body>
</html>