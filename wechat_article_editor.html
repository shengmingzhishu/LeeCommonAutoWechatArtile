<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>微信公众号文章排版编辑器</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* 左侧组件面板 */
        .sidebar {
            width: 280px;
            background-color: #fff;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            background-color: #f9f9f9;
        }

        .sidebar-header h2 {
            font-size: 18px;
            color: #333;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .component-category {
            margin-bottom: 20px;
        }

        .component-category h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }

        .component-item {
            padding: 10px;
            margin-bottom: 8px;
            background-color: #f0f8ff;
            border: 1px solid #d0e8ff;
            border-radius: 4px;
            cursor: move;
            user-select: none;
            transition: all 0.2s;
        }

        .component-item:hover {
            background-color: #e1f0ff;
            border-color: #a0d0ff;
        }

        .template-item {
            padding: 10px;
            margin-bottom: 8px;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .template-item:hover {
            background-color: #eef7ff;
            border-color: #4a90e2;
        }

        .template-item.selected {
            background-color: #4a90e2;
            color: white;
        }

        /* 主编辑区域 */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .toolbar {
            padding: 10px 20px;
            background-color: #fff;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
        }

        .toolbar-btn {
            padding: 8px 15px;
            background-color: #4a90e2;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .toolbar-btn:hover {
            background-color: #357ae8;
        }

        .toolbar-btn.secondary {
            background-color: #6c757d;
        }

        .toolbar-btn.secondary:hover {
            background-color: #5a6268;
        }

        .canvas-container {
            flex: 1;
            overflow: auto;
            padding: 20px;
            background-color: #f9f9f9;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .canvas {
            width: 100%;
            max-width: 800px;
            min-height: 1000px;
            background-color: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            padding: 40px;
        }

        .canvas-element {
            position: absolute;
            cursor: move;
            border: 1px dashed transparent;
        }

        .canvas-element:hover {
            border-color: #4a90e2;
        }

        .canvas-element.selected {
            border-color: #4a90e2;
            box-shadow: 0 0 5px rgba(74, 144, 226, 0.5);
        }
        
        /* SVG相关样式 */
        .svg-element {
            position: absolute;
        }
        
        .svg-container {
            width: 100%;
            height: 100%;
        }
        
        /* 元素控制手柄 */
        .element-controls {
            position: absolute;
            top: -25px;
            right: 0;
            display: flex;
            gap: 5px;
        }
        
        .control-btn {
            width: 20px;
            height: 20px;
            border: 1px solid #999;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        .control-btn.delete {
            background-color: #ff6b6b;
            color: white;
        }
        
        .control-btn.resize {
            background-color: #4a90e2;
            color: white;
        }

        /* 模板管理弹窗 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: bold;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .form-group textarea {
            height: 100px;
            resize: vertical;
        }

        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        /* 拖拽指示器 */
        .drag-over {
            border: 2px dashed #4a90e2 !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 左侧组件面板 -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>排版编辑器</h2>
            </div>
            <div class="sidebar-content">
                <!-- 组件库 -->
                <div class="component-category">
                    <h3>基础组件</h3>
                    <div class="component-item" draggable="true" data-type="text">文本框</div>
                    <div class="component-item" draggable="true" data-type="title">标题</div>
                    <div class="component-item" draggable="true" data-type="image">图片</div>
                    <div class="component-item" draggable="true" data-type="divider">分割线</div>
                    <div class="component-item" draggable="true" data-type="svg">SVG图形</div>
                </div>

                <!-- 模板库 -->
                <div class="component-category">
                    <h3>模板库</h3>
                    <div class="template-item" data-template="default">默认模板</div>
                    <div class="template-item" data-template="image">图片排版模板</div>
                    <div class="template-item" data-template="book">图书介绍模板</div>
                    <div class="template-item" data-template="md">MD优化模板</div>
                </div>

                <!-- 模板管理 -->
                <div class="component-category">
                    <h3>模板管理</h3>
                    <div class="template-item" id="save-template-btn">保存当前为模板</div>
                    <div class="template-item" id="load-template-btn">加载模板</div>
                    <div class="template-item" id="import-template-btn">导入模板</div>
                    <div class="template-item" id="export-template-btn">导出模板</div>
                </div>
            </div>
        </div>

        <!-- 主编辑区域 -->
        <div class="main-content">
            <div class="toolbar">
                <button class="toolbar-btn" id="new-btn">新建</button>
                <button class="toolbar-btn" id="undo-btn">撤销</button>
                <button class="toolbar-btn" id="redo-btn">重做</button>
                <button class="toolbar-btn secondary" id="preview-btn">预览</button>
                <button class="toolbar-btn secondary" id="publish-btn">发布</button>
            </div>
            <div class="canvas-container">
                <div class="canvas" id="main-canvas"></div>
            </div>
        </div>
    </div>

    <!-- 保存模板弹窗 -->
    <div class="modal" id="save-template-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">保存模板</div>
                <button class="close-btn" id="close-save-modal">&times;</button>
            </div>
            <div class="form-group">
                <label for="template-name">模板名称</label>
                <input type="text" id="template-name" placeholder="输入模板名称">
            </div>
            <div class="form-group">
                <label for="template-desc">模板描述</label>
                <textarea id="template-desc" placeholder="输入模板描述"></textarea>
            </div>
            <div class="modal-buttons">
                <button class="toolbar-btn secondary" id="cancel-save">取消</button>
                <button class="toolbar-btn" id="confirm-save">保存</button>
            </div>
        </div>
    </div>

    <!-- 加载模板弹窗 -->
    <div class="modal" id="load-template-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">加载模板</div>
                <button class="close-btn" id="close-load-modal">&times;</button>
            </div>
            <div id="template-list"></div>
            <div class="modal-buttons">
                <button class="toolbar-btn secondary" id="close-load-modal-btn">关闭</button>
            </div>
        </div>
    </div>

    <!-- 导入模板弹窗 -->
    <div class="modal" id="import-template-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">导入模板</div>
                <button class="close-btn" id="close-import-modal">&times;</button>
            </div>
            <div class="form-group">
                <label for="template-file">选择模板文件</label>
                <input type="file" id="template-file" accept=".json">
            </div>
            <div class="modal-buttons">
                <button class="toolbar-btn secondary" id="cancel-import">取消</button>
                <button class="toolbar-btn" id="confirm-import">导入</button>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let selectedElement = null;
        let canvas = null;
        let history = [];
        let historyIndex = -1;
        let templates = JSON.parse(localStorage.getItem('wechatTemplates') || '{}');

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            canvas = document.getElementById('main-canvas');
            initEventListeners();
            loadDefaultTemplate();
            updateTemplateList();
        });

        // 初始化事件监听器
        function initEventListeners() {
            // 组件拖拽
            document.querySelectorAll('.component-item').forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
            });

            canvas.addEventListener('dragover', handleDragOver);
            canvas.addEventListener('drop', handleDrop);

            // 模板选择
            document.querySelectorAll('.template-item[data-template]').forEach(item => {
                item.addEventListener('click', () => loadTemplate(item.dataset.template));
            });

            // 工具栏按钮
            document.getElementById('new-btn').addEventListener('click', newCanvas);
            document.getElementById('undo-btn').addEventListener('click', undo);
            document.getElementById('redo-btn').addEventListener('click', redo);
            document.getElementById('preview-btn').addEventListener('click', preview);
            document.getElementById('publish-btn').addEventListener('click', publish);

            // 模板管理按钮
            document.getElementById('save-template-btn').addEventListener('click', openSaveTemplateModal);
            document.getElementById('load-template-btn').addEventListener('click', openLoadTemplateModal);
            document.getElementById('import-template-btn').addEventListener('click', openImportTemplateModal);
            document.getElementById('export-template-btn').addEventListener('click', exportCurrentTemplate);

            // 保存模板模态框
            document.getElementById('close-save-modal').addEventListener('click', closeSaveTemplateModal);
            document.getElementById('cancel-save').addEventListener('click', closeSaveTemplateModal);
            document.getElementById('confirm-save').addEventListener('click', saveTemplate);

            // 加载模板模态框
            document.getElementById('close-load-modal').addEventListener('click', closeLoadTemplateModal);
            document.getElementById('close-load-modal-btn').addEventListener('click', closeLoadTemplateModal);

            // 导入模板模态框
            document.getElementById('close-import-modal').addEventListener('click', closeImportTemplateModal);
            document.getElementById('cancel-import').addEventListener('click', closeImportTemplateModal);
            document.getElementById('confirm-import').addEventListener('click', importTemplate);
            
            // 添加键盘事件监听器
            document.addEventListener('keydown', handleKeyDown);
        }

        // 拖拽开始事件
        function handleDragStart(e) {
            e.dataTransfer.setData('text/plain', e.target.dataset.type);
        }

        // 拖拽悬停事件
        function handleDragOver(e) {
            e.preventDefault();
        }

        // 拖拽放置事件
        function handleDrop(e) {
            e.preventDefault();
            const type = e.dataTransfer.getData('text/plain');
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            createElement(type, x, y);
            saveToHistory();
        }

        // 创建元素
        function createElement(type, x, y) {
            const element = document.createElement('div');
            element.className = 'canvas-element';
            element.style.left = x + 'px';
            element.style.top = y + 'px';
            element.style.position = 'absolute';
            
            // 根据类型添加内容
            switch(type) {
                case 'text':
                    element.innerHTML = `
                        <div contenteditable="true" style="padding: 10px; border: 1px solid #ddd; min-height: 50px; width: 300px;">在此输入文本</div>
                        <div class="element-controls">
                            <div class="control-btn delete" title="删除" onclick="deleteElement(this)">×</div>
                        </div>
                    `;
                    break;
                case 'title':
                    element.innerHTML = `
                        <div contenteditable="true" style="padding: 10px; font-size: 24px; font-weight: bold; color: #333; min-height: 40px; width: 400px;">在此输入标题</div>
                        <div class="element-controls">
                            <div class="control-btn delete" title="删除" onclick="deleteElement(this)">×</div>
                        </div>
                    `;
                    break;
                case 'image':
                    element.innerHTML = `
                        <div style="width: 200px; height: 150px; background-color: #f0f0f0; border: 1px solid #ddd; display: flex; align-items: center; justify-content: center; position: relative;">
                            <div style="position: absolute; top: 5px; right: 5px; font-size: 12px; color: #666;">图片</div>
                            <div style="text-align: center;">点击上传图片</div>
                        </div>
                        <div class="element-controls">
                            <div class="control-btn delete" title="删除" onclick="deleteElement(this)">×</div>
                        </div>
                    `;
                    break;
                case 'divider':
                    element.innerHTML = `
                        <div style="height: 1px; background-color: #ddd; margin: 10px 0; width: 100%;"></div>
                        <div class="element-controls">
                            <div class="control-btn delete" title="删除" onclick="deleteElement(this)">×</div>
                        </div>
                    `;
                    break;
                case 'svg':
                    element.innerHTML = `
                        <div class="svg-container" style="width: 300px; height: 200px; border: 1px solid #ddd;">
                            <svg width="100%" height="100%" style="background-color: #f9f9f9;">
                                <rect x="50" y="50" width="200" height="100" fill="#4a90e2" stroke="#357ae8" stroke-width="2"></rect>
                            </svg>
                        </div>
                        <div class="element-controls">
                            <div class="control-btn delete" title="删除" onclick="deleteElement(this)">×</div>
                        </div>
                    `;
                    break;
            }
            
            element.dataset.type = type;
            element.addEventListener('click', selectElement);
            makeDraggable(element);
            canvas.appendChild(element);
        }

        // 选择元素
        function selectElement(e) {
            // 防止事件冒泡导致重复选择
            e.stopPropagation();
            
            if (selectedElement) {
                selectedElement.classList.remove('selected');
            }
            selectedElement = e.currentTarget;
            selectedElement.classList.add('selected');
        }

        // 使元素可拖动
        function makeDraggable(element) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;

            element.onmousedown = dragMouseDown;

            function dragMouseDown(e) {
                e = e || window.event;
                e.preventDefault();
                // 获取鼠标位置
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }

            function elementDrag(e) {
                e = e || window.event;
                e.preventDefault();
                // 计算新位置
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                // 设置新位置
                const top = (element.offsetTop - pos2);
                const left = (element.offsetLeft - pos1);
                
                // 限制元素在画布内
                const canvasRect = canvas.getBoundingClientRect();
                const elementRect = element.getBoundingClientRect();
                
                if (left >= 0 && left + elementRect.width <= canvasRect.width) {
                    element.style.left = left + "px";
                }
                if (top >= 0 && top + elementRect.height <= canvasRect.height) {
                    element.style.top = top + "px";
                }
                
                saveToHistory();
            }

            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }

        // 删除元素
        function deleteElement(controlBtn) {
            const element = controlBtn.closest('.canvas-element');
            if (element) {
                element.remove();
                if (selectedElement === element) {
                    selectedElement = null;
                }
                saveToHistory();
            }
        }

        // 键盘事件处理
        function handleKeyDown(e) {
            if (selectedElement) {
                // 删除选中元素 (Delete键)
                if (e.key === 'Delete' || (e.key === 'Backspace' && e.target.tagName !== 'INPUT')) {
                    e.preventDefault();
                    deleteElement(selectedElement.querySelector('.control-btn.delete'));
                }
                // 复制选中元素 (Ctrl+C)
                else if (e.key === 'c' && e.ctrlKey) {
                    e.preventDefault();
                    copyElement(selectedElement);
                }
                // 粘贴元素 (Ctrl+V)
                else if (e.key === 'v' && e.ctrlKey) {
                    e.preventDefault();
                    pasteElement();
                }
            }
        }

        // 复制元素
        function copyElement(element) {
            const rect = element.getBoundingClientRect();
            const canvasRect = canvas.getBoundingClientRect();
            const offsetX = 20; // 偏移量，避免完全重叠
            const offsetY = 20;
            
            // 将元素信息存储到全局变量
            window.copiedElementData = {
                type: element.dataset.type,
                x: Math.min(rect.left - canvasRect.left + offsetX, canvasRect.width - 250), // 防止超出画布
                y: Math.min(rect.top - canvasRect.top + offsetY, canvasRect.height - 100),
                content: element.innerHTML
            };
        }

        // 粘贴元素
        function pasteElement() {
            if (window.copiedElementData) {
                const data = window.copiedElementData;
                createElement(data.type, data.x, data.y);
                saveToHistory();
            }
        }

        // 清空画布
        function newCanvas() {
            canvas.innerHTML = '';
            selectedElement = null;
            saveToHistory();
        }

        // 保存到历史记录
        function saveToHistory() {
            // 防止连续操作产生过多历史记录
            if (history.length > 0 && history[historyIndex] === canvas.innerHTML) {
                return;
            }
            
            const state = canvas.innerHTML;
            history = history.slice(0, historyIndex + 1);
            history.push(state);
            
            // 限制历史记录数量，避免占用过多内存
            if (history.length > 50) {
                history.shift();
                historyIndex = history.length - 1;
            } else {
                historyIndex = history.length - 1;
            }
        }

        // 撤销
        function undo() {
            if (historyIndex > 0) {
                historyIndex--;
                canvas.innerHTML = history[historyIndex];
                selectedElement = null;
            }
        }

        // 重做
        function redo() {
            if (historyIndex < history.length - 1) {
                historyIndex++;
                canvas.innerHTML = history[historyIndex];
                selectedElement = null;
            }
        }

        // 预览
        function preview() {
            const previewWindow = window.open('', '_blank');
            previewWindow.document.write(`
                <html>
                    <head>
                        <title>预览</title>
                        <style>
                            body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
                            .title { font-size: 24px; font-weight: bold; margin-bottom: 20px; }
                            .content { line-height: 1.6; }
                        </style>
                    </head>
                    <body>${canvas.innerHTML}</body>
                </html>
            `);
        }

        // 发布功能 - 集成微信公众号API
        function publish() {
            // 获取当前画布内容
            const content = canvas.innerHTML;
            
            // 检查内容是否为空
            if (!content.trim()) {
                alert('请先添加内容再发布');
                return;
            }
            
            // 确认发布
            if (confirm('确定要发布当前内容吗？发布后将保存为草稿。')) {
                // 这里可以集成微信公众号API
                // 模拟发布过程
                alert('发布成功！内容已保存为草稿。');
                
                // 在实际应用中，这里会调用微信API
                // 示例代码：
                /*
                fetch('https://api.weixin.qq.com/cgi-bin/draft/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer YOUR_ACCESS_TOKEN'
                    },
                    body: JSON.stringify({
                        articles: [{
                            title: '文章标题',
                            content: content,
                            author: '作者',
                            digest: '摘要',
                            thumb_media_id: '封面图片ID'
                        }]
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.media_id) {
                        alert('发布成功！');
                    } else {
                        alert('发布失败：' + data.errmsg);
                    }
                })
                .catch(error => {
                    alert('发布失败：' + error.message);
                });
                */
            }
        }

        // 加载默认模板
        function loadDefaultTemplate() {
            canvas.innerHTML = `
                <div class="canvas-element" style="left: 50px; top: 50px; position: absolute;" data-type="title">
                    <div contenteditable="true" style="padding: 10px; font-size: 24px; font-weight: bold; color: #333; min-height: 40px;">文章标题</div>
                </div>
                <div class="canvas-element" style="left: 50px; top: 120px; position: absolute;" data-type="text">
                    <div contenteditable="true" style="padding: 10px; border: 1px solid #ddd; min-height: 50px;">在此输入文章正文内容...</div>
                </div>
            `;
        }

        // 加载指定模板
        function loadTemplate(templateKey) {
            if (templates[templateKey]) {
                canvas.innerHTML = templates[templateKey].content;
                selectedElement = null;
                saveToHistory();
            } else {
                // 如果是预设模板
                switch(templateKey) {
                    case 'image':
                        loadImageTemplate();
                        break;
                    case 'book':
                        loadBookTemplate();
                        break;
                    case 'md':
                        loadMdTemplate();
                        break;
                    default:
                        loadDefaultTemplate();
                }
            }
        }

        // 导出当前模板为文件
        function exportCurrentTemplate() {
            const name = prompt('请输入模板文件名:', 'my_template');
            if (!name) return;
            
            const templateData = {
                name: name,
                description: '导出的模板',
                content: canvas.innerHTML,
                exportedAt: new Date().toISOString(),
                version: '1.0'
            };
            
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(templateData, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", name + ".json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        // 加载图片排版模板
        function loadImageTemplate() {
            canvas.innerHTML = `
                <div class="canvas-element" style="left: 50px; top: 50px; position: absolute;" data-type="title">
                    <div contenteditable="true" style="padding: 10px; font-size: 24px; font-weight: bold; color: #333; min-height: 40px; text-align: center;">图片排版标题</div>
                </div>
                <div class="canvas-element" style="left: 50px; top: 120px; position: absolute;" data-type="image">
                    <div class="image-container" style="width: 300px; height: 200px; background-color: #f0f0f0; border: 1px solid #ddd; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden;">
                        <div style="position: absolute; top: 5px; right: 5px; font-size: 12px; color: #666; z-index: 2;">图片1</div>
                        <div style="text-align: center; z-index: 1;">点击上传图片</div>
                        <input type="file" accept="image/*" style="position: absolute; width: 100%; height: 100%; top: 0; left: 0; opacity: 0; cursor: pointer;" onchange="handleImageUpload(this)">
                    </div>
                </div>
                <div class="canvas-element" style="left: 50px; top: 340px; position: absolute;" data-type="text">
                    <div contenteditable="true" style="padding: 10px; border: 1px solid #ddd; min-height: 50px; font-style: italic;">图片描述文字</div>
                </div>
                <div class="canvas-element" style="left: 50px; top: 420px; position: absolute;" data-type="divider">
                    <div style="height: 1px; background-color: #ddd; margin: 10px 0;"></div>
                </div>
                <div class="canvas-element" style="left: 50px; top: 440px; position: absolute;" data-type="image">
                    <div class="image-container" style="width: 200px; height: 150px; background-color: #f0f0f0; border: 1px solid #ddd; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden;">
                        <div style="position: absolute; top: 5px; right: 5px; font-size: 12px; color: #666; z-index: 2;">图片2</div>
                        <div style="text-align: center; z-index: 1;">点击上传图片</div>
                        <input type="file" accept="image/*" style="position: absolute; width: 100%; height: 100%; top: 0; left: 0; opacity: 0; cursor: pointer;" onchange="handleImageUpload(this)">
                    </div>
                </div>
                <div class="canvas-element" style="left: 300px; top: 440px; position: absolute;" data-type="image">
                    <div class="image-container" style="width: 200px; height: 150px; background-color: #f0f0f0; border: 1px solid #ddd; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden;">
                        <div style="position: absolute; top: 5px; right: 5px; font-size: 12px; color: #666; z-index: 2;">图片3</div>
                        <div style="text-align: center; z-index: 1;">点击上传图片</div>
                        <input type="file" accept="image/*" style="position: absolute; width: 100%; height: 100%; top: 0; left: 0; opacity: 0; cursor: pointer;" onchange="handleImageUpload(this)">
                    </div>
                </div>
            `;
        }

        // 加载图书介绍模板
        function loadBookTemplate() {
            canvas.innerHTML = `
                <div class="canvas-element" style="left: 50px; top: 50px; position: absolute;" data-type="title">
                    <div contenteditable="true" style="padding: 10px; font-size: 28px; font-weight: bold; color: #2c3e50; min-height: 40px; text-align: center;">今日推荐好书</div>
                </div>
                <div class="canvas-element" style="left: 50px; top: 130px; position: absolute;" data-type="text">
                    <div contenteditable="true" style="padding: 15px; border: 2px solid #3498db; border-radius: 8px; min-height: 60px; background-color: #f8f9fa; font-weight: bold; font-size: 18px; color: #2c3e50;">
                        1. 《书籍名称》
                    </div>
                </div>
                <div class="canvas-element" style="left: 50px; top: 220px; position: absolute;" data-type="text">
                    <div contenteditable="true" style="padding: 10px; min-height: 80px; line-height: 1.6; color: #34495e;">
                        <strong>推荐理由：</strong>这是一本非常值得阅读的书籍，内容丰富，观点独特，能够启发思考。
                        <br><br>
                        <strong>适合人群：</strong>对相关领域感兴趣的人士、学生、研究者等。
                    </div>
                </div>
                <div class="canvas-element" style="left: 50px; top: 340px; position: absolute;" data-type="text">
                    <div contenteditable="true" style="padding: 15px; border: 2px solid #e74c3c; border-radius: 8px; min-height: 60px; background-color: #f8f9fa; font-weight: bold; font-size: 18px; color: #2c3e50;">
                        2. 《书籍名称》
                    </div>
                </div>
                <div class="canvas-element" style="left: 50px; top: 430px; position: absolute;" data-type="text">
                    <div contenteditable="true" style="padding: 10px; min-height: 80px; line-height: 1.6; color: #34495e;">
                        <strong>推荐理由：</strong>这本书提供了全新的视角，帮助读者更好地理解相关主题。
                        <br><br>
                        <strong>适合人群：</strong>初学者、进阶读者。
                    </div>
                </div>
                <div class="canvas-element" style="left: 50px; top: 550px; position: absolute;" data-type="text">
                    <div contenteditable="true" style="padding: 15px; border: 2px solid #2ecc71; border-radius: 8px; min-height: 60px; background-color: #f8f9fa; font-weight: bold; font-size: 18px; color: #2c3e50;">
                        3. 《书籍名称》
                    </div>
                </div>
                <div class="canvas-element" style="left: 50px; top: 640px; position: absolute;" data-type="text">
                    <div contenteditable="true" style="padding: 10px; min-height: 80px; line-height: 1.6; color: #34495e;">
                        <strong>推荐理由：</strong>经典之作，经过时间考验，是该领域的必读书目。
                        <br><br>
                        <strong>适合人群：</strong>所有对该领域感兴趣的人。
                    </div>
                </div>
            `;
        }

        // 加载MD优化模板
        function loadMdTemplate() {
            canvas.innerHTML = `
                <div class="canvas-element" style="left: 50px; top: 50px; position: absolute;" data-type="title">
                    <div contenteditable="true" style="padding: 10px; font-size: 28px; font-weight: bold; color: #2c3e50; min-height: 40px; text-align: center;">MD格式优化标题</div>
                </div>
                <div class="canvas-element" style="left: 50px; top: 130px; position: absolute;" data-type="text">
                    <div contenteditable="true" id="md-content" style="padding: 10px; line-height: 1.8; min-height: 50px; color: #34495e; width: 500px;">
                        # 一级标题示例
                        ## 二级标题示例
                        这是**加粗**文本和*斜体*文本示例。
                        
                        - 列表项 1
                        - 列表项 2
                        - 列表项 3
                        
                        > 这是引用文本示例
                    </div>
                </div>
                <div class="canvas-element" style="left: 50px; top: 400px; position: absolute;" data-type="text">
                    <button onclick="applyMdFormatting()" style="padding: 8px 15px; background-color: #4a90e2; color: white; border: none; border-radius: 4px; cursor: pointer;">应用MD格式</button>
                </div>
            `;
        }

        // 打开保存模板模态框
        function openSaveTemplateModal() {
            document.getElementById('save-template-modal').style.display = 'flex';
        }

        // 关闭保存模板模态框
        function closeSaveTemplateModal() {
            document.getElementById('save-template-modal').style.display = 'none';
            document.getElementById('template-name').value = '';
            document.getElementById('template-desc').value = '';
        }

        // 保存模板
        function saveTemplate() {
            const name = document.getElementById('template-name').value.trim();
            const desc = document.getElementById('template-desc').value.trim();
            
            if (!name) {
                alert('请输入模板名称');
                return;
            }
            
            templates[name] = {
                name: name,
                description: desc,
                content: canvas.innerHTML,
                createdAt: new Date().toISOString()
            };
            
            localStorage.setItem('wechatTemplates', JSON.stringify(templates));
            updateTemplateList();
            closeSaveTemplateModal();
            alert('模板保存成功！');
        }

        // 打开加载模板模态框
        function openLoadTemplateModal() {
            updateTemplateList();
            document.getElementById('load-template-modal').style.display = 'flex';
        }

        // 更新模板列表
        function updateTemplateList() {
            const container = document.getElementById('template-list');
            container.innerHTML = '';
            
            for (const key in templates) {
                const template = templates[key];
                const item = document.createElement('div');
                item.className = 'template-item';
                item.innerHTML = `
                    <div style="font-weight: bold;">${template.name}</div>
                    <div style="font-size: 12px; color: #666;">${template.description || '无描述'}</div>
                    <div style="font-size: 11px; color: #999; margin-top: 5px;">${new Date(template.createdAt).toLocaleString()}</div>
                    <div style="margin-top: 10px; display: flex; gap: 5px;">
                        <button class="toolbar-btn secondary" style="padding: 3px 8px; font-size: 12px;" onclick="loadSavedTemplate('${key}')">加载</button>
                        <button class="toolbar-btn secondary" style="padding: 3px 8px; font-size: 12px;" onclick="deleteTemplate('${key}')">删除</button>
                    </div>
                `;
                container.appendChild(item);
            }
        }

        // 加载已保存的模板
        function loadSavedTemplate(key) {
            if (templates[key]) {
                canvas.innerHTML = templates[key].content;
                selectedElement = null;
                saveToHistory();
                closeLoadTemplateModal();
            }
        }

        // 删除模板
        function deleteTemplate(key) {
            if (confirm(`确定要删除模板 "${templates[key].name}" 吗？`)) {
                delete templates[key];
                localStorage.setItem('wechatTemplates', JSON.stringify(templates));
                updateTemplateList();
            }
        }

        // 关闭加载模板模态框
        function closeLoadTemplateModal() {
            document.getElementById('load-template-modal').style.display = 'none';
        }

        // 打开导入模板模态框
        function openImportTemplateModal() {
            document.getElementById('import-template-modal').style.display = 'flex';
        }

        // 关闭导入模板模态框
        function closeImportTemplateModal() {
            document.getElementById('import-template-modal').style.display = 'none';
            document.getElementById('template-file').value = '';
        }

        // 导入模板
        function importTemplate() {
            const fileInput = document.getElementById('template-file');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('请选择一个模板文件');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // 检查是否是单个模板文件
                    if (importedData.content !== undefined) {
                        // 单个模板文件
                        const templateName = importedData.name || '导入的模板_' + new Date().getTime();
                        templates[templateName] = {
                            name: templateName,
                            description: importedData.description || '导入的模板',
                            content: importedData.content,
                            createdAt: new Date().toISOString()
                        };
                    } else {
                        // 多个模板的集合文件
                        for (const key in importedData) {
                            const template = importedData[key];
                            if (template.content) {
                                templates[template.name || key] = template;
                            }
                        }
                    }
                    
                    localStorage.setItem('wechatTemplates', JSON.stringify(templates));
                    updateTemplateList();
                    closeImportTemplateModal();
                    alert('模板导入成功！');
                } catch (error) {
                    alert('模板文件格式错误: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // 导出当前模板
        function exportCurrentTemplate() {
            const templateData = {
                content: canvas.innerHTML,
                exportedAt: new Date().toISOString()
            };
            
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(templateData, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "wechat_template.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        // MD格式化处理函数
        function applyMdFormatting() {
            const mdContentElement = document.getElementById('md-content');
            if (!mdContentElement) {
                alert('未找到MD内容元素');
                return;
            }
            
            let content = mdContentElement.innerText || mdContentElement.textContent;
            
            // 处理标题
            content = content.replace(/^### (.*$)/gm, '<h3 style="font-size: 18px; font-weight: bold; color: #333; margin: 10px 0;">$1</h3>');
            content = content.replace(/^## (.*$)/gm, '<h2 style="font-size: 22px; font-weight: bold; color: #333; margin: 12px 0;">$1</h2>');
            content = content.replace(/^# (.*$)/gm, '<h1 style="font-size: 26px; font-weight: bold; color: #333; margin: 15px 0;">$1</h1>');
            
            // 处理粗体和斜体
            content = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            content = content.replace(/\*(.*?)\*/g, '<em>$1</em>');
            content = content.replace(/__(.*?)__/g, '<strong>$1</strong>');
            content = content.replace(/_(.*?)_/g, '<em>$1</em>');
            
            // 处理引用
            content = content.replace(/^> (.*$)/gm, '<div style="border-left: 4px solid #4a90e2; padding-left: 10px; margin: 10px 0; background-color: #f8f9fa; font-style: italic;">$1</div>');
            
            // 处理列表
            content = content.replace(/^- (.*$)/gm, '<li style="margin: 5px 0;">$1</li>');
            content = content.replace(/(<li style="margin: 5px 0;">.*<\/li>)+/g, '<ul style="padding-left: 20px;">// 全局函数，供HTML调用
        window.loadSavedTemplate = loadSavedTemplate;
        window.deleteTemplate = deleteTemplate;
    </script>
</body>
</html></ul>');
            
            // 处理换行
            content = content.replace(/\n/g, '<br>');
            
            // 更新内容
            mdContentElement.innerHTML = content;
            
            saveToHistory();
        }

        // 处理图片上传
        function handleImageUpload(inputElement) {
            const file = inputElement.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imgContainer = inputElement.parentElement;
                    // 创建图片元素
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.style.width = '100%';
                    img.style.height = '100%';
                    img.style.objectFit = 'cover';
                    
                    // 清空容器并添加图片
                    imgContainer.innerHTML = '';
                    imgContainer.appendChild(img);
                    
                    // 添加文件名显示
                    const fileNameDiv = document.createElement('div');
                    fileNameDiv.textContent = file.name;
                    fileNameDiv.style.position = 'absolute';
                    fileNameDiv.style.bottom = '5px';
                    fileNameDiv.style.left = '5px';
                    fileNameDiv.style.fontSize = '12px';
                    fileNameDiv.style.color = 'white';
                    fileNameDiv.style.backgroundColor = 'rgba(0,0,0,0.5)';
                    fileNameDiv.style.padding = '2px 5px';
                    fileNameDiv.style.borderRadius = '3px';
                    fileNameDiv.style.zIndex = '2';
                    imgContainer.appendChild(fileNameDiv);
                    
                    saveToHistory();
                };
                reader.readAsDataURL(file);
            }
        }

        // 全局函数，供HTML调用
        window.loadSavedTemplate = loadSavedTemplate;
        window.deleteTemplate = deleteTemplate;
        window.applyMdFormatting = applyMdFormatting;
        window.handleImageUpload = handleImageUpload;
    </script>
</body>
</html>